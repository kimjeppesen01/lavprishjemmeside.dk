<!DOCTYPE html><html lang="da"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noindex, nofollow"><title>Master Hub â€” Admin</title><link rel="stylesheet" href="/_astro/ai-assemble.d66byh88.css"></head> <body class="min-h-screen bg-gray-50 text-gray-900 antialiased"> <!-- Auth guard: redirect if no token (runs before anything renders) --> <script>
    (function() {
      var token = localStorage.getItem('admin_token');
      var path = window.location.pathname.replace(/\/$/, '') || '/admin';
      var isLoginPage = path === '/admin';
      if (!token && !isLoginPage) {
        window.location.href = '/admin/';
        return;
      }
      if (token && isLoginPage) {
        window.location.href = '/admin/dashboard/';
        return;
      }
    })();
    </script> <div class="flex min-h-screen"> <!-- Sidebar --> <aside id="admin-sidebar" class="hidden w-64 bg-gray-900 text-gray-100 min-h-screen flex-col"> <div class="p-4 border-b border-gray-700"> <a href="/admin/dashboard/" class="text-lg font-bold text-white">LPH Admin</a> </div> <nav class="flex-1 p-4 space-y-1"> <a href="/admin/master/" id="master-hub-link" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm font-medium">
Master Hub
</a> <div class="border-t border-gray-700 my-1"></div> <a href="/admin/dashboard/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Oversigt
</a> <a href="/admin/traffic/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
ğŸ“ˆ Trafik
</a> <div class="pt-2 mt-2 border-t border-gray-700"> <p class="px-3 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">Webstedskonfig</p> <a href="/admin/pages/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Sider
</a> <a href="/admin/styling/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Design &amp; styling
</a> <a href="/admin/header-footer/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Header &amp; Footer
</a> <a href="/admin/components/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Komponenter
</a> <a href="/admin/ai-assemble/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
AI-assembler
</a> </div> </nav> <div class="p-4 border-t border-gray-700"> <button id="logout-btn" class="w-full text-left text-sm text-gray-400 hover:text-white">
Log ud
</button> </div> </aside> <!-- Main content --> <div class="flex-1 flex flex-col"> <!-- Top bar --> <header id="admin-header" class="hidden bg-white border-b border-gray-200 px-6 py-3 items-center justify-between"> <button id="mobile-menu-btn" class="lg:hidden text-gray-600 text-sm">
&#9776; Menu
</button> <div class="flex-1"></div> <span id="admin-email" class="text-sm text-gray-500"></span> </header> <!-- Page content --> <main class="flex-1 p-6">  <script>
    (function() {
      try {
        var token = localStorage.getItem('admin_token');
        if (!token) return;
        var payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'master') {
          window.location.replace('/admin/dashboard/?message=master_required');
          return;
        }
      } catch(e) {}
    })();
  </script> <div class="flex items-center justify-between mb-6"> <h1 class="text-2xl font-bold">Master Hub</h1> <span class="text-xs text-gray-400">lavprishjemmeside.dk only</span> </div>  <div class="flex gap-1 border-b border-gray-200 mb-6"> <button onclick="switchTab('sites')" id="tab-sites" class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-blue-600 text-blue-700">
Sites
</button> <button onclick="switchTab('agents')" id="tab-agents" class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
Agents &amp; Kanban
</button> <button onclick="switchTab('ai')" id="tab-ai" class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
AI Usage
</button> <button onclick="switchTab('claude')" id="tab-claude" class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
Claude Code
</button> </div>  <div id="panel-sites"> <div id="sites-loading" class="text-center py-12 text-gray-400">Henter sitesâ€¦</div> <div id="sites-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 text-sm mb-4"></div> <div id="sites-grid" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-5"></div> <div class="mt-6 pt-4 border-t border-gray-200"> <details> <summary class="text-sm font-medium text-gray-600 cursor-pointer hover:text-gray-900">+ Registrer nyt site</summary> <form id="add-site-form" class="mt-4 bg-white border border-gray-200 rounded-xl p-5 grid grid-cols-1 md:grid-cols-2 gap-4"> <div> <label class="text-xs text-gray-500 block mb-1">Navn</label> <input name="name" placeholder="Min Kunde A/S" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">Domain</label> <input name="domain" placeholder="minkunde.dk" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">API URL</label> <input name="api_url" placeholder="https://api.minkunde.dk" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">Admin URL</label> <input name="admin_url" placeholder="https://minkunde.dk/admin/" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">DB Name</label> <input name="db_name" placeholder="theartis_minkunde" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">DB User</label> <input name="db_user" placeholder="theartis_minkunde" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">DB Password</label> <input name="db_password" type="password" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div class="md:col-span-2 flex justify-end"> <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">Gem site</button> </div> </form> </details> </div> </div>  <div id="panel-agents" class="hidden"> <!-- IAN agent status cards --> <div class="mb-6"> <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider mb-3">IAN Agent Status</h2> <div id="agent-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4"> <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse h-28"></div> <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse h-28"></div> <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse h-28"></div> </div> </div> <!-- Kanban board --> <div class="mb-4 flex items-center justify-between"> <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Kanban Board</h2> <button onclick="openAddCard()" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700">+ TilfÃ¸j opgave</button> </div> <!-- Add card form (hidden by default) --> <div id="add-card-form" class="hidden bg-white border border-blue-200 rounded-xl p-5 mb-5 grid grid-cols-1 md:grid-cols-2 gap-4"> <div> <label class="text-xs text-gray-500 block mb-1">Titel *</label> <input id="card-title" placeholder="Opgavetitel" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div> <label class="text-xs text-gray-500 block mb-1">Kolonne</label> <select id="card-column" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="backlog">Backlog</option> <option value="in_progress">In Progress</option> <option value="review">Review</option> <option value="done">Done</option> </select> </div> <div class="md:col-span-2"> <label class="text-xs text-gray-500 block mb-1">Beskrivelse</label> <textarea id="card-desc" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"></textarea> </div> <div> <label class="text-xs text-gray-500 block mb-1">Prioritet</label> <select id="card-priority" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="low">Low</option> <option value="medium" selected>Medium</option> <option value="high">High</option> <option value="critical">Critical</option> </select> </div> <div> <label class="text-xs text-gray-500 block mb-1">Tildelt</label> <select id="card-assigned" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="human">Human</option> <option value="haiku">Haiku</option> <option value="sonnet">Sonnet</option> </select> </div> <div> <label class="text-xs text-gray-500 block mb-1">Version target</label> <input id="card-version" placeholder="1.1.0" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> </div> <div class="md:col-span-2 flex gap-2 justify-end"> <button onclick="document.getElementById('add-card-form').classList.add('hidden')" class="px-4 py-2 border border-gray-300 text-sm rounded-lg hover:bg-gray-50">Annuller</button> <button onclick="submitCard()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">Gem</button> </div> </div> <div id="kanban-loading" class="text-center py-12 text-gray-400">Henter kanbanâ€¦</div> <div id="kanban-board" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"></div> </div>  <div id="panel-ai" class="hidden"> <div id="ai-loading" class="text-center py-12 text-gray-400">Henter AI-forbrugâ€¦</div> <div id="ai-content" class="hidden space-y-6"></div> </div>  <div id="panel-claude" class="hidden"> <div class="bg-white border border-gray-200 rounded-xl p-5 mb-4"> <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 mb-4"> <div class="border border-gray-200 rounded-xl p-3 bg-gradient-to-br from-blue-50 to-white"> <p class="text-[11px] uppercase tracking-wide text-blue-700 font-semibold mb-1">Step 1</p> <label class="text-xs text-gray-500 block mb-1">Repository</label> <select id="claude-repo" onchange="onClaudeRepoOrTaskChange()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="">Henter reposâ€¦</option> </select> </div> <div class="border border-gray-200 rounded-xl p-3 bg-gradient-to-br from-emerald-50 to-white"> <p class="text-[11px] uppercase tracking-wide text-emerald-700 font-semibold mb-1">Step 2</p> <div class="flex items-center gap-2 mb-1"> <label class="text-xs text-gray-500 block">Kanban task</label> <button onclick="loadClaudeKanbanTasks()" class="text-[11px] px-2 py-0.5 rounded border border-gray-200 hover:bg-gray-50">Refresh</button> </div> <select id="claude-task" onchange="onClaudeRepoOrTaskChange()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="">VÃ¦lg taskâ€¦</option> </select> </div> <div class="border border-gray-200 rounded-xl p-3 bg-gradient-to-br from-amber-50 to-white"> <p class="text-[11px] uppercase tracking-wide text-amber-700 font-semibold mb-1">Step 3</p> <div class="flex items-center gap-2 mb-1"> <label class="text-xs text-gray-500 block">Plan .md file</label> <button onclick="loadTaskMdFiles()" class="text-[11px] px-2 py-0.5 rounded border border-gray-200 hover:bg-gray-50">Refresh</button> </div> <select id="claude-md-file" onchange="updateRunButtonState()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="">VÃ¦lg .md-filâ€¦</option> </select> <div id="claude-md-help" class="text-[11px] text-gray-500 mt-1">A run requires a planning .md file.</div> <button onclick="createNewPlanMd()" class="mt-2 text-xs px-2.5 py-1 rounded-lg border border-gray-300 hover:bg-gray-50">Create new .md plan</button> </div> </div> <div class="flex flex-wrap gap-3 items-end mb-4"> <div> <label class="text-xs text-gray-500 block mb-1">Model</label> <select id="claude-model" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="sonnet">Sonnet 4.6 (default)</option> <option value="haiku">Haiku 4.5 (fast / cheap)</option> <option value="opus">Opus 4.6 (powerful)</option> </select> </div> <div> <input id="claude-account" type="hidden" value="/home/theartis/.claude"> <div class="flex items-center gap-1.5 mt-1.5"> <span id="auth-dot" class="inline-block w-2 h-2 rounded-full bg-gray-300 flex-shrink-0"></span> <span id="auth-label" class="text-xs text-gray-400 truncate">Checkingâ€¦</span> </div> </div> <div> <label class="text-xs text-gray-500 block mb-1">Timeout</label> <select id="claude-timeout" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"> <option value="10">10 min</option> <option value="30">30 min</option> <option value="60">60 min</option> </select> </div> </div> <div class="mb-3"> <label class="text-xs text-gray-500 block mb-1">Task / prompt</label> <textarea id="claude-prompt" rows="5" placeholder="Describe the task for Claude Codeâ€¦
e.g. Run node api/run-schema.cjs and report any errors" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono resize-y"></textarea> </div> <div class="flex gap-2 flex-wrap"> <button onclick="runClaude()" id="claude-run-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 font-medium">
â–¶ Run
</button> <button onclick="killClaude()" id="claude-kill" class="hidden px-4 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 font-medium">
â–  Kill
</button> <button onclick="clearOutput()" class="px-4 py-2 border border-gray-300 text-gray-600 text-sm rounded-lg hover:bg-gray-50">
Clear
</button> <button onclick="openAuthPanel()" class="ml-auto px-4 py-2 border border-gray-300 text-gray-600 text-sm rounded-lg hover:bg-gray-50">
Auth Account
</button> </div> </div> <!-- Auth panel (shown when "Auth Account" is clicked) --> <div id="claude-auth-panel" class="hidden bg-white border border-blue-200 rounded-xl p-5 mb-4"> <div class="flex items-center justify-between mb-3"> <p class="text-sm font-semibold text-gray-800">Authenticate Claude Account</p> <button onclick="closeAuthPanel()" class="text-gray-400 hover:text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-100">âœ• Close</button> </div> <ol class="text-xs text-gray-500 mb-4 space-y-1 list-decimal list-inside"> <li>Click <strong>Generate Auth URL</strong></li> <li>Click the link that appears and authorize in your browser</li> <li>The callback page shows: <em>"Authentication Code â€” Paste this into Claude Code:"</em></li> <li>Paste that code into the field below and click <strong>Submit Code</strong></li> </ol> <div class="flex gap-2 mb-3"> <button onclick="startClaudeAuth()" id="auth-start-btn" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 font-medium">
Generate Auth URL
</button> <span id="auth-spinner" class="hidden text-xs text-gray-400 self-center">Generatingâ€¦</span> </div> <div id="auth-url-box" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3 text-xs"> <p class="text-gray-500 mb-1">Open this URL in your browser to authorize:</p> <a id="auth-url-link" href="#" target="_blank" rel="noopener" class="text-blue-700 break-all hover:underline font-mono"></a> </div> <pre id="auth-output" class="hidden text-xs font-mono bg-gray-950 text-green-400 rounded-lg p-3 max-h-40 overflow-auto whitespace-pre-wrap break-all mb-3"></pre> <div class="flex gap-2"> <input id="auth-code-input" type="text" placeholder="Paste Authentication Code hereâ€¦" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono"> <button onclick="submitAuthCode()" class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 font-medium whitespace-nowrap">Submit Code</button> </div> <p id="auth-status" class="text-xs mt-2 text-gray-500"></p> </div> <!-- Output terminal --> <div class="bg-gray-950 rounded-xl border border-gray-800 p-4 min-h-64"> <div class="flex items-center justify-between mb-3"> <span class="text-xs text-gray-500 font-mono">Output</span> <span id="claude-status" class="text-xs text-gray-500"></span> </div> <pre id="claude-output" class="text-sm font-mono whitespace-pre-wrap break-words overflow-auto max-h-[60vh] text-gray-300"></pre> </div> </div>  </main> </div> </div> <!-- Sidebar/header visibility + logout --> <script>
    (function() {
      var path = window.location.pathname.replace(/\/$/, '') || '/admin';
      if (path === '/admin') return;

      // Show sidebar and header on dashboard pages
      var sidebar = document.getElementById('admin-sidebar');
      var header = document.getElementById('admin-header');
      if (sidebar) { sidebar.classList.remove('hidden'); sidebar.classList.add('lg:flex'); }
      if (header) { header.classList.remove('hidden'); header.classList.add('flex'); }

      // Show admin email from JWT; hide Master Hub for non-master
      try {
        var token = localStorage.getItem('admin_token');
        if (token) {
          var payload = JSON.parse(atob(token.split('.')[1]));
          var emailEl = document.getElementById('admin-email');
          if (emailEl) emailEl.textContent = payload.email || '';
          var masterLink = document.getElementById('master-hub-link');
          if (masterLink && payload.role !== 'master') {
            masterLink.style.display = 'none';
          }
        }
      } catch(e) {}

      // Logout
      var logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          localStorage.removeItem('admin_token');
          window.location.href = '/admin/';
        });
      }

      // Mobile menu toggle
      var menuBtn = document.getElementById('mobile-menu-btn');
      if (menuBtn && sidebar) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('fixed');
          sidebar.classList.toggle('z-50');
          sidebar.classList.toggle('inset-0');
          sidebar.classList.toggle('flex');
        });
      }

      // Highlight active nav item
      var normalizedPath = path.replace(/\/$/, '') || '/admin';
      var links = sidebar ? sidebar.querySelectorAll('nav a[href]') : [];
      links.forEach(function(a) {
        var href = a.getAttribute('href') || '';
        var linkPath = href.replace(/\/$/, '') || '/admin';
        if (normalizedPath === linkPath) {
          a.classList.add('bg-gray-800', 'text-white');
          a.classList.remove('hover:bg-gray-800');
        }
      });
    })();
    </script>  </body></html> <script>(function(){const apiUrl = "https://api.lavprishjemmeside.dk";

var API = apiUrl;
var activeTab = 'sites';
var kanbanData = {};
var currentTaskId = null;
var masterStepUpToken = sessionStorage.getItem('master_step_up_token') || '';

// â”€â”€â”€ Auth helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders() {
  var token = localStorage.getItem('admin_token');
  var headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
  if (masterStepUpToken) headers['x-master-step-up-token'] = masterStepUpToken;
  return headers;
}

function ensureMasterStepUp() {
  return fetch(API + '/master/step-up-status', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(status) {
      if (!status.required || status.verified) return true;
      var password = prompt('Master step-up required. Re-enter your password:');
      if (!password) return false;
      return fetch(API + '/master/step-up', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ password: password })
      }).then(function(r) { return r.json(); }).then(function(j) {
        if (!j.ok || !j.token) {
          alert(j.error || 'Step-up authentication failed');
          return false;
        }
        masterStepUpToken = j.token;
        sessionStorage.setItem('master_step_up_token', j.token);
        return true;
      });
    })
    .catch(function() {
      return true;
    });
}

// â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  ['sites', 'agents', 'ai', 'claude'].forEach(function(t) {
    var panel = document.getElementById('panel-' + t);
    var btn = document.getElementById('tab-' + t);
    if (panel) panel.classList.toggle('hidden', t !== tab);
    if (btn) {
      btn.classList.toggle('border-blue-600', t === tab);
      btn.classList.toggle('text-blue-700', t === tab);
      btn.classList.toggle('border-transparent', t !== tab);
      btn.classList.toggle('text-gray-500', t !== tab);
    }
  });
  activeTab = tab;
  if (tab === 'sites') loadSites();
  if (tab === 'agents') { loadAgents(); loadKanban(); }
  if (tab === 'ai') loadAiUsage();
  if (tab === 'claude') {
    ensureMasterStepUp().then(function(ok) {
      if (!ok) return;
      loadClaudeRepos();
      loadClaudeKanbanTasks();
      loadClaudeAccounts();
      updateRunButtonState();
    });
  }
}

// â”€â”€â”€ Sites tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function healthDot(status) {
  var colors = { online: 'bg-green-500', degraded: 'bg-amber-400', offline: 'bg-red-500', unknown: 'bg-gray-400' };
  return '<span class="inline-block w-2.5 h-2.5 rounded-full ' + (colors[status] || 'bg-gray-400') + '"></span>';
}

function priorityBadge(p) {
  var map = { low: 'bg-gray-100 text-gray-600', medium: 'bg-blue-100 text-blue-700', high: 'bg-amber-100 text-amber-700', critical: 'bg-red-100 text-red-700' };
  return '<span class="text-xs px-2 py-0.5 rounded-full font-medium ' + (map[p] || map.medium) + '">' + p + '</span>';
}

function assignedLabel(a) {
  var map = { haiku: 'Haiku', sonnet: 'Sonnet', human: 'Human' };
  return map[a] || a;
}

function fmt(n) { return Number(n).toLocaleString('da-DK'); }
function fmtCost(n) { return '$' + Number(n).toFixed(4); }

function renderSiteCard(site) {
  return '<div class="bg-white border border-gray-200 rounded-xl p-5 space-y-3">' +
    '<div class="flex items-center justify-between">' +
      '<div>' +
        '<a href="' + site.admin_url + '" target="_blank" class="font-semibold text-gray-900 hover:text-blue-600">' + site.name + '</a>' +
        '<p class="text-xs text-gray-500">' + site.domain + '</p>' +
      '</div>' +
      '<div class="flex items-center gap-2">' +
        healthDot(site.health) +
        '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">v' + site.version + '</span>' +
      '</div>' +
    '</div>' +
    '<div class="grid grid-cols-4 gap-2 text-center">' +
      '<div class="bg-gray-50 rounded-lg p-2"><p class="text-lg font-bold text-gray-900">' + site.pages + '</p><p class="text-xs text-gray-500">Sider</p></div>' +
      '<div class="bg-gray-50 rounded-lg p-2"><p class="text-lg font-bold text-gray-900">' + site.components_used + '</p><p class="text-xs text-gray-500">Kompon.</p></div>' +
      '<div class="bg-gray-50 rounded-lg p-2"><p class="text-lg font-bold text-gray-900">' + site.media + '</p><p class="text-xs text-gray-500">Media</p></div>' +
      '<div class="bg-gray-50 rounded-lg p-2"><p class="text-lg font-bold text-gray-900">' + site.db_size_mb + '</p><p class="text-xs text-gray-500">MB DB</p></div>' +
    '</div>' +
    '<div class="flex items-center justify-between text-xs text-gray-500">' +
      '<span>AI tokens (30d): <strong class="text-gray-800">' + fmt(site.ai_tokens) + '</strong></span>' +
      '<span>Cost: <strong class="text-gray-800">' + fmtCost(site.ai_cost_usd) + '</strong></span>' +
      '<a href="' + site.admin_url + '" target="_blank" class="text-blue-600 hover:underline font-medium">Admin â†’</a>' +
    '</div>' +
  '</div>';
}

function loadSites() {
  var loading = document.getElementById('sites-loading');
  var grid = document.getElementById('sites-grid');
  var errEl = document.getElementById('sites-error');
  loading.classList.remove('hidden');
  grid.classList.add('hidden');
  errEl.classList.add('hidden');

  fetch(API + '/master/sites', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(sites) {
      loading.classList.add('hidden');
      grid.innerHTML = sites.map(renderSiteCard).join('');
      grid.classList.remove('hidden');
    })
    .catch(function(e) {
      loading.classList.add('hidden');
      errEl.textContent = 'Kunne ikke hente sites: ' + e.message;
      errEl.classList.remove('hidden');
    });
}

// Add site form
document.getElementById('add-site-form').addEventListener('submit', function(e) {
  e.preventDefault();
  var data = {};
  new FormData(this).forEach(function(v, k) { if (v) data[k] = v; });
  fetch(API + '/master/sites', { method: 'POST', headers: authHeaders(), body: JSON.stringify(data) })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res.error) { alert(res.error); return; }
      e.target.reset();
      loadSites();
    })
    .catch(function(e) { alert('Fejl: ' + e.message); });
});

// â”€â”€â”€ Agents tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusColor(s) {
  var map = { online: 'bg-green-500', busy: 'bg-amber-400', offline: 'bg-red-400' };
  return map[s] || 'bg-gray-400';
}

function timeSince(ts) {
  if (!ts) return 'Aldrig';
  var d = new Date(ts);
  var secs = Math.floor((Date.now() - d.getTime()) / 1000);
  if (secs < 60) return secs + 's siden';
  if (secs < 3600) return Math.floor(secs / 60) + 'm siden';
  if (secs < 86400) return Math.floor(secs / 3600) + 't siden';
  return Math.floor(secs / 86400) + 'd siden';
}

function renderAgentCard(agent) {
  var names = { haiku: 'Haiku Worker', sonnet: 'Sonnet Worker', ian: 'IAN Orchestrator' };
  return '<div class="bg-white border border-gray-200 rounded-xl p-5">' +
    '<div class="flex items-center gap-3 mb-3">' +
      '<span class="inline-block w-3 h-3 rounded-full ' + statusColor(agent.status) + '"></span>' +
      '<span class="font-semibold text-gray-900">' + (names[agent.agent_type] || agent.agent_type) + '</span>' +
      '<span class="ml-auto text-xs text-gray-400">' + timeSince(agent.last_seen) + '</span>' +
    '</div>' +
    (agent.current_task ? '<p class="text-xs text-gray-600 mb-3 truncate" title="' + agent.current_task + '">' + agent.current_task + '</p>' : '<p class="text-xs text-gray-400 mb-3">Ingen aktiv opgave</p>') +
    '<div class="grid grid-cols-3 gap-2 text-center">' +
      '<div><p class="text-sm font-bold">' + (agent.messages_sent_today || 0) + '</p><p class="text-xs text-gray-400">Slack msgs</p></div>' +
      '<div><p class="text-sm font-bold">' + fmt(agent.tokens_used_today || 0) + '</p><p class="text-xs text-gray-400">Tokens</p></div>' +
      '<div><p class="text-sm font-bold">' + fmtCost(agent.cost_usd_today || 0) + '</p><p class="text-xs text-gray-400">Cost</p></div>' +
    '</div>' +
  '</div>';
}

function loadAgents() {
  fetch(API + '/master/ian-status', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(agents) {
      var grid = document.getElementById('agent-cards');
      grid.innerHTML = agents.length
        ? agents.map(renderAgentCard).join('')
        : '<p class="text-sm text-gray-400 col-span-3">Ingen heartbeat data modtaget endnu.</p>';
    })
    .catch(function() {
      document.getElementById('agent-cards').innerHTML = '<p class="text-sm text-red-500 col-span-3">Kunne ikke hente agent status.</p>';
    });
}

// â”€â”€â”€ Kanban â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var COLUMNS = [
  { key: 'backlog', label: 'Backlog' },
  { key: 'in_progress', label: 'In Progress' },
  { key: 'review', label: 'Review' },
  { key: 'done', label: 'Done' },
];

function renderKanbanCard(item, colIndex) {
  var canLeft = colIndex > 0;
  var canRight = colIndex < COLUMNS.length - 1;
  return '<div class="bg-white border border-gray-200 rounded-lg p-3 space-y-2">' +
    '<div class="flex items-start justify-between gap-2">' +
      '<p class="text-sm font-medium text-gray-900 leading-tight">' + escHtml(item.title) + '</p>' +
      '<button onclick="deleteCard(' + item.id + ')" class="text-gray-300 hover:text-red-500 text-xs shrink-0">âœ•</button>' +
    '</div>' +
    (item.description ? '<p class="text-xs text-gray-500 line-clamp-2">' + escHtml(item.description) + '</p>' : '') +
    '<div class="flex flex-wrap gap-1 items-center">' +
      priorityBadge(item.priority) +
      '<span class="text-xs text-gray-400">' + assignedLabel(item.assigned_to) + '</span>' +
      (item.version_target ? '<span class="text-xs text-gray-400">v' + item.version_target + '</span>' : '') +
    '</div>' +
    '<div class="flex gap-1 justify-end pt-1">' +
      (canLeft ? '<button onclick="moveCard(' + item.id + ',\'' + COLUMNS[colIndex - 1].key + '\')" class="text-xs px-2 py-0.5 rounded border border-gray-200 hover:bg-gray-100">â†</button>' : '') +
      (canRight ? '<button onclick="moveCard(' + item.id + ',\'' + COLUMNS[colIndex + 1].key + '\')" class="text-xs px-2 py-0.5 rounded border border-gray-200 hover:bg-gray-100">â†’</button>' : '') +
    '</div>' +
  '</div>';
}

function renderKanban(data) {
  var board = document.getElementById('kanban-board');
  board.innerHTML = COLUMNS.map(function(col, idx) {
    var items = data[col.key] || [];
    return '<div class="flex flex-col gap-2">' +
      '<div class="flex items-center justify-between mb-1">' +
        '<h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500">' + col.label + '</h3>' +
        '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">' + items.length + '</span>' +
      '</div>' +
      '<div class="flex flex-col gap-2 min-h-16">' +
        (items.length ? items.map(function(item) { return renderKanbanCard(item, idx); }).join('') : '<p class="text-xs text-gray-300 text-center py-4">Tom</p>') +
      '</div>' +
    '</div>';
  }).join('');
}

function loadKanban() {
  var loading = document.getElementById('kanban-loading');
  var board = document.getElementById('kanban-board');
  loading.classList.remove('hidden');
  board.classList.add('hidden');

  fetch(API + '/master/kanban', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      kanbanData = data;
      loading.classList.add('hidden');
      renderKanban(data);
      board.classList.remove('hidden');
    })
    .catch(function() {
      loading.textContent = 'Kunne ikke hente kanban.';
    });
}

function moveCard(id, newCol) {
  fetch(API + '/master/kanban/' + id, {
    method: 'PUT',
    headers: authHeaders(),
    body: JSON.stringify({ column_name: newCol })
  }).then(function() { loadKanban(); });
}

function deleteCard(id) {
  if (!confirm('Slet opgave?')) return;
  fetch(API + '/master/kanban/' + id, { method: 'DELETE', headers: authHeaders() })
    .then(function() { loadKanban(); });
}

function openAddCard() {
  document.getElementById('add-card-form').classList.remove('hidden');
  document.getElementById('card-title').focus();
}

function submitCard() {
  var title = document.getElementById('card-title').value.trim();
  if (!title) { alert('Titel er pÃ¥krÃ¦vet'); return; }
  var data = {
    title: title,
    description: document.getElementById('card-desc').value.trim() || null,
    column_name: document.getElementById('card-column').value,
    priority: document.getElementById('card-priority').value,
    assigned_to: document.getElementById('card-assigned').value,
    version_target: document.getElementById('card-version').value.trim() || null,
  };
  fetch(API + '/master/kanban', { method: 'POST', headers: authHeaders(), body: JSON.stringify(data) })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res.error) { alert(res.error); return; }
      document.getElementById('add-card-form').classList.add('hidden');
      document.getElementById('card-title').value = '';
      document.getElementById('card-desc').value = '';
      document.getElementById('card-version').value = '';
      loadKanban();
    })
    .catch(function(e) { alert('Fejl: ' + e.message); });
}

// â”€â”€â”€ AI Usage tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMiniChart(usageRows) {
  if (!usageRows || !usageRows.length) return '<p class="text-xs text-gray-400">Ingen data</p>';
  var max = Math.max.apply(null, usageRows.map(function(r) { return Number(r.tokens) || 0; })) || 1;
  var bars = usageRows.slice(-14).map(function(r) {
    var h = Math.max(2, Math.round((Number(r.tokens) / max) * 40));
    return '<div title="' + r.day + ': ' + fmt(r.tokens) + ' tokens" style="height:' + h + 'px" class="bg-blue-400 rounded-sm w-3 mt-auto"></div>';
  }).join('');
  return '<div class="flex items-end gap-0.5 h-12">' + bars + '</div>';
}

function loadAiUsage() {
  var loading = document.getElementById('ai-loading');
  var content = document.getElementById('ai-content');
  loading.classList.remove('hidden');
  content.classList.add('hidden');

  fetch(API + '/master/ai-usage', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(sites) {
      loading.classList.add('hidden');
      content.innerHTML = sites.map(function(site) {
        var totalTokens = (site.usage || []).reduce(function(s, r) { return s + Number(r.tokens); }, 0);
        var totalCost = (site.usage || []).reduce(function(s, r) { return s + Number(r.cost_usd); }, 0);
        return '<div class="bg-white border border-gray-200 rounded-xl p-5">' +
          '<div class="flex items-center justify-between mb-3">' +
            '<div>' +
              '<p class="font-semibold text-gray-900">' + site.site + '</p>' +
              '<p class="text-xs text-gray-400">' + site.domain + '</p>' +
            '</div>' +
            '<div class="text-right">' +
              '<p class="text-sm font-bold">' + fmt(totalTokens) + ' tokens</p>' +
              '<p class="text-xs text-gray-500">' + fmtCost(totalCost) + ' (30 dage)</p>' +
            '</div>' +
          '</div>' +
          renderMiniChart(site.usage) +
          (site.error ? '<p class="text-xs text-red-400 mt-2">DB utilgÃ¦ngelig</p>' : '') +
        '</div>';
      }).join('') || '<p class="text-gray-400 text-sm">Ingen sites fundet.</p>';
      content.classList.remove('hidden');
    })
    .catch(function() {
      loading.textContent = 'Kunne ikke hente AI-forbrug.';
    });
}

// â”€â”€â”€ Claude Code Runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var claudeTasks = [];

function loadClaudeRepos() {
  var sel = document.getElementById('claude-repo');
  if (!sel) return;
  fetch(API + '/master/claude-repos', { headers: authHeaders() })
    .then(function(r) {
      if (!r.ok) throw new Error(r.status === 403 ? 'Kun master-brugere' : 'Kunne ikke hente repos');
      return r.json();
    })
    .then(function(repos) {
      sel.innerHTML = repos.map(function(r) {
        return '<option value="' + r.domain + '">' + r.name + ' (' + r.domain + ')</option>';
      }).join('');
      if (repos.length && !sel.value) sel.selectedIndex = 0;
      onClaudeRepoOrTaskChange();
    })
    .catch(function(e) {
      sel.innerHTML = '<option value="">Fejl: ' + (e.message || 'Kunne ikke hente') + '</option>';
    });
}

function loadClaudeKanbanTasks() {
  var sel = document.getElementById('claude-task');
  if (!sel) return;
  fetch(API + '/master/kanban-tasks', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(tasks) {
      claudeTasks = tasks || [];
      sel.innerHTML = '<option value="">VÃ¦lg taskâ€¦</option>' + claudeTasks.map(function(t) {
        return '<option value="' + t.id + '">#' + t.id + ' Â· ' + escHtml(t.title) + ' (' + t.column_name + ')</option>';
      }).join('');
      onClaudeRepoOrTaskChange();
    })
    .catch(function() {
      sel.innerHTML = '<option value="">Kunne ikke hente tasks</option>';
    });
}

function getSelectedTaskId() {
  var sel = document.getElementById('claude-task');
  var n = parseInt(sel && sel.value, 10);
  return n || null;
}

function onClaudeRepoOrTaskChange() {
  loadTaskMdFiles();
  updateRunButtonState();
}

function loadTaskMdFiles() {
  var repoEl = document.getElementById('claude-repo');
  var taskId = getSelectedTaskId();
  var mdSel = document.getElementById('claude-md-file');
  var help = document.getElementById('claude-md-help');
  if (!repoEl || !mdSel || !help) return;
  if (!repoEl.value || !taskId) {
    mdSel.innerHTML = '<option value="">VÃ¦lg repo + task fÃ¸rst</option>';
    help.textContent = 'A run requires a planning .md file.';
    updateRunButtonState();
    return;
  }
  mdSel.innerHTML = '<option value="">Henter .md-filerâ€¦</option>';
  fetch(API + '/master/task-md-files?task_id=' + encodeURIComponent(taskId) + '&repo=' + encodeURIComponent(repoEl.value), { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var associated = data.associated || [];
      var suggested = data.suggested || [];
      var all = data.all || [];
      var opts = ['<option value="">VÃ¦lg .md-filâ€¦</option>'];
      if (associated.length) {
        opts.push('<optgroup label="Associated with task">');
        associated.forEach(function(p) { opts.push('<option value="' + escHtml(p) + '">' + escHtml(p) + '</option>'); });
        opts.push('</optgroup>');
      }
      if (suggested.length) {
        opts.push('<optgroup label="Suggested">');
        suggested.forEach(function(p) { opts.push('<option value="' + escHtml(p) + '">' + escHtml(p) + '</option>'); });
        opts.push('</optgroup>');
      }
      opts.push('<optgroup label="All docs">');
      all.forEach(function(p) { opts.push('<option value="' + escHtml(p) + '">' + escHtml(p) + '</option>'); });
      opts.push('</optgroup>');
      mdSel.innerHTML = opts.join('');
      if (associated.length) mdSel.value = associated[0];
      help.textContent = associated.length ? 'Task-linked plan file detected.' : 'No linked .md file found for this task.';
      updateRunButtonState();
    })
    .catch(function() {
      mdSel.innerHTML = '<option value="">Kunne ikke hente .md-filer</option>';
      help.textContent = 'A run requires a planning .md file.';
      updateRunButtonState();
    });
}

function createNewPlanMd() {
  var taskId = getSelectedTaskId();
  var repoEl = document.getElementById('claude-repo');
  if (!taskId || !repoEl || !repoEl.value) {
    alert('VÃ¦lg repo og kanban task fÃ¸rst');
    return Promise.resolve(false);
  }
  return fetch(API + '/master/task-md-files', {
    method: 'POST',
    headers: authHeaders(),
    body: JSON.stringify({ task_id: taskId, repo: repoEl.value, mode: 'create' })
  }).then(function(r) { return r.json(); })
    .then(function(j) {
      if (!j.ok) {
        alert(j.error || 'Kunne ikke oprette .md plan');
        return false;
      }
      return loadTaskMdFiles(), new Promise(function(resolve) {
        setTimeout(function() {
          var mdSel = document.getElementById('claude-md-file');
          if (mdSel && j.file_path) mdSel.value = j.file_path;
          updateRunButtonState();
          resolve(true);
        }, 200);
      });
    })
    .catch(function(e) {
      alert('Fejl: ' + e.message);
      return false;
    });
}

function loadClaudeAccounts() {
  fetch(API + '/master/claude-accounts', { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(accounts) {
      var sel = document.getElementById('claude-account');
      if (sel) {
        sel.innerHTML = accounts.map(function(a) {
          return '<option value="' + a.configDir + '">' + a.label + '</option>';
        }).join('');
      }
      loadAuthStatus();
    })
    .catch(function() { loadAuthStatus(); });
}

function loadAuthStatus() {
  var sel = document.getElementById('claude-account');
  var dot = document.getElementById('auth-dot');
  var label = document.getElementById('auth-label');
  if (!sel || !dot || !label) return;
  var account_dir = sel.value;
  fetch(API + '/master/claude-auth-status?account_dir=' + encodeURIComponent(account_dir), { headers: authHeaders() })
    .then(function(r) { return r.json(); })
    .then(function(s) {
      if (s.authenticated) {
        dot.className = 'inline-block w-2 h-2 rounded-full bg-green-500 flex-shrink-0';
        var display = s.email || s.name || 'Authenticated';
        label.textContent = display;
        label.className = 'text-xs text-green-700 truncate';
      } else if (s.expired) {
        dot.className = 'inline-block w-2 h-2 rounded-full bg-amber-400 flex-shrink-0';
        label.textContent = 'Token expired â€” re-authenticate';
        label.className = 'text-xs text-amber-600 truncate';
      } else {
        dot.className = 'inline-block w-2 h-2 rounded-full bg-gray-300 flex-shrink-0';
        label.textContent = 'Not authenticated';
        label.className = 'text-xs text-gray-400 truncate';
      }
    })
    .catch(function() {
      dot.className = 'inline-block w-2 h-2 rounded-full bg-gray-300 flex-shrink-0';
      label.textContent = 'Status unknown';
      label.className = 'text-xs text-gray-400 truncate';
    });
}

function appendOutput(text, colorClass) {
  var out = document.getElementById('claude-output');
  var span = document.createElement('span');
  span.className = colorClass || 'text-gray-300';
  span.textContent = text;
  out.appendChild(span);
  // Trim oldest output if too long
  if (out.children.length > 5000) {
    for (var i = 0; i < 1000; i++) { if (out.firstChild) out.removeChild(out.firstChild); }
  }
  out.scrollTop = out.scrollHeight;
}

function clearOutput() {
  document.getElementById('claude-output').innerHTML = '';
  document.getElementById('claude-status').textContent = '';
}

function setRunning(running) {
  var runBtn = document.getElementById('claude-run-btn');
  var killBtn = document.getElementById('claude-kill');
  if (runBtn) runBtn.disabled = running || !canRunClaude();
  if (killBtn) killBtn.classList.toggle('hidden', !running);
  document.getElementById('claude-status').textContent = running ? 'Runningâ€¦' : '';
}

function canRunClaude() {
  var body = (document.getElementById('claude-prompt').value || '').trim();
  var repo = document.getElementById('claude-repo').value;
  var taskId = getSelectedTaskId();
  var mdPath = document.getElementById('claude-md-file').value;
  return Boolean(body && repo && taskId && mdPath);
}

function updateRunButtonState() {
  var runBtn = document.getElementById('claude-run-btn');
  if (runBtn) runBtn.disabled = !canRunClaude();
}

function runClaude() {
  var body = document.getElementById('claude-prompt').value.trim();
  if (!body) { updateRunButtonState(); return; }
  var repo        = document.getElementById('claude-repo').value;
  var model       = document.getElementById('claude-model').value;
  var account_dir = document.getElementById('claude-account').value;
  var timeout_min = parseInt(document.getElementById('claude-timeout').value) || 10;
  var task_id = getSelectedTaskId();
  var md_path = document.getElementById('claude-md-file').value;

  if (!repo || !task_id) {
    alert('VÃ¦lg repository og kanban task fÃ¸rst');
    updateRunButtonState();
    return;
  }

  var createdNewPlan = false;
  var ensurePlan = Promise.resolve(true);
  if (!md_path) {
    if (!confirm('Should we plan a new .md file?')) {
      updateRunButtonState();
      return;
    }
    ensurePlan = createNewPlanMd().then(function(ok) {
      if (ok) {
        createdNewPlan = true;
        md_path = document.getElementById('claude-md-file').value;
      }
      return ok;
    });
  }

  ensurePlan.then(function(ok) {
    if (!ok || !md_path) {
      updateRunButtonState();
      return;
    }
    clearOutput();
    setRunning(true);
    appendOutput('$ claude --model ' + model + ' --print --dangerously-skip-permissions\n', 'text-gray-500');
    appendOutput('  repo: ' + repo + ' | task: #' + task_id + ' | md: ' + md_path + '\n', 'text-gray-600');
    appendOutput('  account: ' + account_dir + ' | timeout: ' + timeout_min + 'min\n\n', 'text-gray-600');

    fetch(API + '/master/claude-run', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({
        prompt: body,
        repo: repo,
        model: model,
        account_dir: account_dir,
        timeout_min: timeout_min,
        task_id: task_id,
        md_path: md_path,
        created_new_plan: createdNewPlan
      }),
    }).then(function(res) {
      if (res.status === 403) {
        return res.json().then(function(j) {
          if (j.code === 'STEP_UP_REQUIRED') {
            appendOutput('Step-up authentication required. Run cancelled.\n', 'text-amber-400');
          } else {
            appendOutput('Error: ' + (j.error || 'Forbidden') + '\n', 'text-red-400');
          }
          setRunning(false);
        });
      }
      if (res.status === 409 || res.status === 400) {
        return res.json().then(function(j) {
          appendOutput('Error: ' + j.error + '\n', 'text-red-400');
          setRunning(false);
        });
      }
      currentTaskId = res.headers.get('X-Task-Id');
      if (!res.body) {
        appendOutput('Error: No response body (SSE not supported?)\n', 'text-red-400');
        setRunning(false);
        return;
      }
      var reader = res.body.getReader();
      var decoder = new TextDecoder();
      var buf = '';
      var statusEl = document.getElementById('claude-status');

      var hitLimit = false;

      function isLimitMsg(text) {
        return /hit.{0,30}limit|usage.?limit|rate.?limit|overloaded|too many|resets\s+\w+\s+\d/i.test(text);
      }

      function read() {
        return reader.read().then(function(chunk) {
          if (chunk.done) { setRunning(false); currentTaskId = null; updateRunButtonState(); return; }
          buf += decoder.decode(chunk.value, { stream: true });
          var lines = buf.split('\n');
          buf = lines.pop();
          lines.forEach(function(line) {
            if (!line.startsWith('data: ')) return;
            var raw = line.slice(6).trim();
            if (!raw) return;
            var ev;
            try { ev = JSON.parse(raw); } catch { return; }
            if (ev.type === 'start' && ev.md_path) {
              appendOutput('[Using plan file: ' + ev.md_path + (ev.kanban_task_id ? ' | task #' + ev.kanban_task_id : '') + ']\n', 'text-cyan-300');
            }
            if (ev.type === 'out') {
              if (isLimitMsg(ev.text)) {
                hitLimit = true;
                appendOutput(ev.text, 'text-purple-400');
                if (statusEl) statusEl.textContent = 'Usage limit reached';
              } else {
                appendOutput(ev.text, 'text-green-400');
              }
            }
            if (ev.type === 'err') {
              if (isLimitMsg(ev.text)) {
                hitLimit = true;
                appendOutput(ev.text, 'text-purple-400');
                if (statusEl) statusEl.textContent = 'Usage limit reached';
              } else {
                appendOutput(ev.text, 'text-amber-400');
              }
            }
            if (ev.type === 'done') {
              if (hitLimit) {
                appendOutput('\nClaude Pro daily limit reached. Check the message above for reset time.\n', 'text-purple-400');
              } else {
                appendOutput('\n[Exited with code ' + ev.code + ']\n', ev.code === 0 ? 'text-blue-400' : 'text-red-400');
              }
              setRunning(false);
              currentTaskId = null;
              updateRunButtonState();
            }
          });
          return read();
        });
      }
      return read();
    }).catch(function(err) {
      appendOutput('Request failed: ' + err.message + '\n', 'text-red-400');
      setRunning(false);
      updateRunButtonState();
    });
  });
}

function killClaude() {
  if (!currentTaskId) return;
  fetch(API + '/master/claude-run/' + currentTaskId, { method: 'DELETE', headers: authHeaders() })
    .then(function() {
      appendOutput('\n[Killed by user]\n', 'text-amber-400');
      setRunning(false);
      currentTaskId = null;
      updateRunButtonState();
    });
}

// â”€â”€â”€ Claude Auth Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAuthPanel() {
  document.getElementById('claude-auth-panel').classList.remove('hidden');
}
function closeAuthPanel() {
  document.getElementById('claude-auth-panel').classList.add('hidden');
}

function startClaudeAuth() {
  var account_dir = document.getElementById('claude-account').value;
  var out = document.getElementById('auth-output');
  var urlBox = document.getElementById('auth-url-box');
  var urlLink = document.getElementById('auth-url-link');
  var statusEl = document.getElementById('auth-status');
  var spinner = document.getElementById('auth-spinner');
  var startBtn = document.getElementById('auth-start-btn');

  out.classList.add('hidden');
  urlBox.classList.add('hidden');
  statusEl.textContent = '';
  statusEl.className = 'text-xs mt-2 text-gray-500';
  startBtn.disabled = true;
  spinner.classList.remove('hidden');

  fetch(API + '/master/claude-auth-start', {
    method: 'POST',
    headers: authHeaders(),
    body: JSON.stringify({ account_dir: account_dir }),
  }).then(function(r) { return r.json(); })
    .then(function(j) {
      spinner.classList.add('hidden');
      startBtn.disabled = false;

      if (j.error) {
        out.textContent = 'Error: ' + j.error + (j.detail ? '\n' + j.detail : '');
        out.classList.remove('hidden');
        statusEl.textContent = 'Failed â€” see output above';
        statusEl.className = 'text-xs mt-2 text-red-500';
        return;
      }

      if (j.url) {
        urlLink.href = j.url;
        urlLink.textContent = j.url;
        urlBox.classList.remove('hidden');
        statusEl.textContent = 'URL ready â€” click the link above, authorize, then paste the code below';
        statusEl.className = 'text-xs mt-2 text-blue-600';
        document.getElementById('auth-code-input').focus();
      }
    })
    .catch(function(err) {
      spinner.classList.add('hidden');
      startBtn.disabled = false;
      out.textContent = 'Request failed: ' + err.message;
      out.classList.remove('hidden');
      statusEl.textContent = 'Network error';
      statusEl.className = 'text-xs mt-2 text-red-500';
    });
}

function submitAuthCode() {
  var code = document.getElementById('auth-code-input').value.trim();
  var statusEl = document.getElementById('auth-status');
  var out = document.getElementById('auth-output');
  var spinner = document.getElementById('auth-spinner');
  if (!code) {
    statusEl.textContent = 'Paste the authentication code first';
    statusEl.className = 'text-xs mt-2 text-amber-500';
    return;
  }
  statusEl.textContent = 'Submitting code â€” exchanging tokenâ€¦';
  statusEl.className = 'text-xs mt-2 text-gray-500';
  spinner.classList.remove('hidden');

  fetch(API + '/master/claude-auth-code', {
    method: 'POST',
    headers: authHeaders(),
    body: JSON.stringify({ code: code }),
  }).then(function(r) { return r.json(); })
    .then(function(j) {
      spinner.classList.add('hidden');
      document.getElementById('auth-code-input').value = '';
      if (j.ok) {
        out.textContent = 'âœ“ ' + (j.output || 'Authentication successful.');
        out.classList.remove('hidden');
        statusEl.textContent = 'Authenticated! Claude Code will now use your Claude Pro account.';
        statusEl.className = 'text-xs mt-2 text-green-600';
        loadClaudeAccounts();
        loadAuthStatus();
      } else {
        out.textContent = 'âœ— ' + j.error + (j.detail ? '\n' + j.detail : '');
        out.classList.remove('hidden');
        statusEl.textContent = 'Authentication failed â€” see output above';
        statusEl.className = 'text-xs mt-2 text-red-500';
      }
    })
    .catch(function(err) {
      spinner.classList.add('hidden');
      statusEl.textContent = 'Request failed: ' + err.message;
      statusEl.className = 'text-xs mt-2 text-red-500';
    });
}

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Expose onclick-called functions to global scope (define:vars wraps in IIFE)
window.switchTab = switchTab;
window.openAddCard = openAddCard;
window.submitCard = submitCard;
window.moveCard = moveCard;
window.deleteCard = deleteCard;
window.runClaude = runClaude;
window.killClaude = killClaude;
window.clearOutput = clearOutput;
window.loadClaudeAccounts = loadClaudeAccounts;
window.loadClaudeKanbanTasks = loadClaudeKanbanTasks;
window.loadTaskMdFiles = loadTaskMdFiles;
window.onClaudeRepoOrTaskChange = onClaudeRepoOrTaskChange;
window.createNewPlanMd = createNewPlanMd;
window.updateRunButtonState = updateRunButtonState;
window.openAuthPanel = openAuthPanel;
window.closeAuthPanel = closeAuthPanel;
window.startClaudeAuth = startClaudeAuth;
window.submitAuthCode = submitAuthCode;

var promptInput = document.getElementById('claude-prompt');
if (promptInput) promptInput.addEventListener('input', updateRunButtonState);

// Load initial tab
loadSites();
})();</script>
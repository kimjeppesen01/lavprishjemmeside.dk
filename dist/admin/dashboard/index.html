<!DOCTYPE html><html lang="da"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="noindex, nofollow"><title>Oversigt ‚Äî Admin</title><link rel="stylesheet" href="/_astro/ai-assemble.gXHi6YN7.css"></head> <body class="min-h-screen bg-gray-50 text-gray-900 antialiased"> <!-- Auth guard: redirect if no token (runs before anything renders) --> <script>
    (function() {
      var token = localStorage.getItem('admin_token');
      var path = window.location.pathname.replace(/\/$/, '') || '/admin';
      var isLoginPage = path === '/admin';
      if (!token && !isLoginPage) {
        window.location.href = '/admin/';
        return;
      }
      if (token && isLoginPage) {
        window.location.href = '/admin/dashboard/';
        return;
      }
    })();
    </script> <div class="flex min-h-screen"> <!-- Sidebar --> <aside id="admin-sidebar" class="hidden w-64 bg-gray-900 text-gray-100 min-h-screen flex-col"> <div class="p-4 border-b border-gray-700"> <a href="/admin/dashboard/" class="text-lg font-bold text-white">LPH Admin</a> </div> <nav class="flex-1 p-4 space-y-1"> <a href="/admin/master/" id="master-hub-link" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm font-medium">
Master Hub
</a> <div class="border-t border-gray-700 my-1"></div> <a href="/admin/dashboard/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Oversigt
</a> <a href="/admin/traffic/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
üìà Trafik
</a> <div class="pt-2 mt-2 border-t border-gray-700"> <p class="px-3 py-1 text-xs font-semibold text-gray-500 uppercase tracking-wider">Webstedskonfig</p> <a href="/admin/pages/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Sider
</a> <a href="/admin/styling/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Design &amp; styling
</a> <a href="/admin/themes/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Temaer
</a> <a href="/admin/header-footer/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Header &amp; Footer
</a> <a href="/admin/components/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
Komponenter
</a> <a href="/admin/ai-assemble/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800 text-sm">
AI-assembler
</a> </div> </nav> <div class="p-4 border-t border-gray-700"> <button id="logout-btn" class="w-full text-left text-sm text-gray-400 hover:text-white">
Log ud
</button> </div> </aside> <!-- Main content --> <div class="flex-1 flex flex-col"> <!-- Top bar --> <header id="admin-header" class="hidden bg-white border-b border-gray-200 px-6 py-3 items-center justify-between"> <button id="mobile-menu-btn" class="lg:hidden text-gray-600 text-sm">
&#9776; Menu
</button> <div class="flex-1"></div> <span id="admin-email" class="text-sm text-gray-500"></span> </header> <!-- Page content --> <main class="flex-1 p-6">  <div id="master-required-banner" class="hidden mb-4 rounded-lg bg-amber-50 border border-amber-200 px-4 py-3 text-sm text-amber-800" role="alert">
Kun master-brugere har adgang til Master Hub.
</div> <script>
    (function() {
      if (typeof window !== 'undefined' && window.location.search.indexOf('message=master_required') !== -1) {
        var el = document.getElementById('master-required-banner');
        if (el) el.classList.remove('hidden');
      }
    })();
  </script>  <div id="loading" class="text-center py-12 text-gray-500">Henter data...</div>  <div id="error" class="hidden text-center py-12"> <p class="text-red-600 mb-4" id="error-text"></p> <button onclick="window.location.reload()" class="text-blue-600 underline">Pr√∏v igen</button> </div>  <div id="dashboard" class="hidden"> <div class="flex flex-wrap items-center justify-between gap-4 mb-6"> <h1 class="text-2xl font-bold">Oversigt</h1> <button id="dashboard-publish-btn" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg text-sm">
Publicer til live (~90 sek)
</button> </div> <!-- Settings overview: Pages + Global + Media & SEO --> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8"> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <div class="flex items-center justify-between mb-4"> <h2 class="text-lg font-semibold text-gray-900">Sider</h2> <a href="/admin/pages/" class="text-sm text-blue-600 hover:underline">Rediger ‚Üí</a> </div> <div id="settings-pages" class="space-y-2 text-sm"> <p class="text-gray-500">Henter...</p> </div> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <div class="flex items-center justify-between mb-4"> <h2 class="text-lg font-semibold text-gray-900">Globale indstillinger</h2> <div class="flex gap-3"> <a href="/admin/styling/" class="text-sm text-blue-600 hover:underline">Design ‚Üí</a> <a href="/admin/header-footer/" class="text-sm text-blue-600 hover:underline">Header ‚Üí</a> </div> </div> <div id="settings-global" class="space-y-2 text-sm"> <p class="text-gray-500">Henter...</p> </div> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <div class="flex items-center justify-between mb-4"> <h2 class="text-lg font-semibold text-gray-900">Indhold & SEO</h2> </div> <div class="space-y-3 text-sm"> <a href="/admin/media/" class="flex items-center gap-2 text-blue-600 hover:underline"> <span>üñº</span> Mediebibliotek
</a> <a href="/admin/pages/" class="flex items-center gap-2 text-blue-600 hover:underline"> <span>üîç</span> SEO for sider
</a> <a href="/admin/ai-assemble/" class="flex items-center gap-2 text-blue-600 hover:underline"> <span>‚ö°</span> AI Indholdsudvikler
</a> </div> </div> </div> <!-- Metric cards --> <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <p class="text-sm text-gray-500 mb-1">H√¶ndelser i alt</p> <p class="text-3xl font-bold" id="stat-events-total">&mdash;</p> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <p class="text-sm text-gray-500 mb-1">H√¶ndelser i dag</p> <p class="text-3xl font-bold" id="stat-events-today">&mdash;</p> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <p class="text-sm text-gray-500 mb-1">Sessioner i alt</p> <p class="text-3xl font-bold" id="stat-sessions-total">&mdash;</p> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <p class="text-sm text-gray-500 mb-1">Gns. sider pr. session</p> <p class="text-3xl font-bold" id="stat-avg-pages">&mdash;</p> </div> </div> <!-- Two-column: Top Events + Top Landing Pages --> <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <h2 class="text-lg font-semibold mb-4">Top h√¶ndelser</h2> <table class="w-full text-sm"> <thead> <tr class="text-left text-gray-500 border-b"> <th class="pb-2">H√¶ndelse</th> <th class="pb-2">Type</th> <th class="pb-2 text-right">Antal</th> </tr> </thead> <tbody id="table-top-events"></tbody> </table> </div> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <h2 class="text-lg font-semibold mb-4">Top landingssider</h2> <table class="w-full text-sm"> <thead> <tr class="text-left text-gray-500 border-b"> <th class="pb-2">Side</th> <th class="pb-2 text-right">Sessioner</th> </tr> </thead> <tbody id="table-top-pages"></tbody> </table> </div> </div> <!-- Recent events --> <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5"> <h2 class="text-lg font-semibold mb-4">Seneste h√¶ndelser</h2> <div class="overflow-x-auto"> <table class="w-full text-sm"> <thead> <tr class="text-left text-gray-500 border-b"> <th class="pb-2">Type</th> <th class="pb-2">Navn</th> <th class="pb-2">Side</th> <th class="pb-2">Tidspunkt</th> </tr> </thead> <tbody id="table-recent-events"></tbody> </table> </div> </div> </div> <script>(function(){const apiUrl = "https://api.lavprishjemmeside.dk";

  (function() {
    var API = apiUrl;
    var token = localStorage.getItem('admin_token');
    if (!token) return;

    function authFetch(url) {
      return fetch(url, {
        headers: { 'Authorization': 'Bearer ' + token }
      }).then(function(res) {
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('admin_token');
          window.location.href = '/admin/';
          throw new Error('Unauthorized');
        }
        if (res.status === 503) {
          throw new Error('503 Service Unavailable ‚Äî API-serveren er utilg√¶ngelig. Genstart Node.js p√• serveren (touch api/tmp/restart.txt).');
        }
        if (!res.ok) {
          throw new Error('HTTP ' + res.status + ' ‚Äî ' + res.statusText);
        }
        return res.json();
      });
    }

    function esc(str) {
      var div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function fmt(dateStr) {
      if (!dateStr) return '\u2014';
      var d = new Date(dateStr);
      return d.toLocaleDateString('da-DK') + ' ' + d.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
    }

    Promise.all([
      authFetch(API + '/events/summary').catch(function() {
        return { total: 0, today: 0, top_events: [], recent: [] };
      }),
      authFetch(API + '/sessions/summary').catch(function() {
        return { total: 0, today: 0, avg_pages: 0, top_pages: [], recent: [] };
      }),
      authFetch(API + '/design-settings/').catch(function() { return null; }),
      authFetch(API + '/page-components?page=all').catch(function() { return []; })
    ])
    .then(function(results) {
      var events = results[0] || { total: 0, today: 0, top_events: [], recent: [] };
      var sessions = results[1] || { total: 0, today: 0, avg_pages: 0, top_pages: [], recent: [] };
      var designSettings = results[2];
      var pageComponents = results[3] || [];

      // Settings: Pages (group by page_path)
      var pageGroups = {};
      pageComponents.forEach(function(pc) {
        var path = (pc.page_path || '/').trim();
        if (!pageGroups[path]) pageGroups[path] = { total: 0, published: 0 };
        pageGroups[path].total++;
        if (pc.is_published) pageGroups[path].published++;
      });
      var pagesHtml = '';
      var paths = Object.keys(pageGroups).sort();
      if (paths.length === 0) {
        pagesHtml = '<p class="text-gray-500">Ingen sider endnu. <a href="/admin/ai-assemble/" class="text-blue-600 hover:underline">Opret side</a></p>';
      } else {
        paths.forEach(function(path) {
          var g = pageGroups[path];
          var pub = g.published === g.total ? '<span class="text-green-600">‚óè</span>' : '<span class="text-amber-500">‚óã</span>';
          pagesHtml += '<div class="flex justify-between py-1 border-b border-gray-100 last:border-0">'
            + '<span class="font-mono text-xs">' + esc(path) + '</span>'
            + '<span>' + pub + ' ' + g.published + '/' + g.total + ' komp.</span></div>';
        });
      }
      document.getElementById('settings-pages').innerHTML = pagesHtml;

      // Settings: Global (design) + feature toggles
      var globalHtml = '';
      if (designSettings) {
        globalHtml = '<div class="flex items-center gap-2 py-1"><span class="w-4 h-4 rounded border border-gray-300" style="background:' + esc(designSettings.color_primary || '#2563EB') + '"></span><span>Prim√¶r: ' + esc(designSettings.color_primary || '‚Äî') + '</span></div>'
          + '<div class="py-1">Font: ' + esc(designSettings.font_heading || designSettings.font_body || '‚Äî') + '</div>'
          + '<div class="py-1">Kantradius: ' + esc(designSettings.border_radius || '‚Äî') + '</div>'
          + '<div class="py-1">Skygge: ' + esc(designSettings.shadow_style || '‚Äî') + '</div>'
          + '<div class="pt-2 mt-2 border-t border-gray-100 space-y-1"><span class="text-xs text-gray-500 uppercase tracking-wider">Funktioner</span>'
          + '<div class="py-1">' + ((designSettings.feature_smooth_scroll ?? 1) !== 0 ? '<span class="text-green-600">‚óè</span>' : '<span class="text-gray-400">‚óã</span>') + ' Smooth scroll</div>'
          + '<div class="py-1">' + ((designSettings.feature_grain_overlay ?? 1) !== 0 ? '<span class="text-green-600">‚óè</span>' : '<span class="text-gray-400">‚óã</span>') + ' Korn-overlay</div>'
          + '<div class="py-1">' + ((designSettings.feature_page_loader ?? 1) !== 0 ? '<span class="text-green-600">‚óè</span>' : '<span class="text-gray-400">‚óã</span>') + ' Sideloader</div>'
          + '<div class="py-1">' + ((designSettings.feature_sticky_header ?? 1) !== 0 ? '<span class="text-green-600">‚óè</span>' : '<span class="text-gray-400">‚óã</span>') + ' Kl√¶bende header</div></div>';
      } else {
        globalHtml = '<p class="text-gray-500">Kunne ikke hente. <a href="/admin/styling/" class="text-blue-600 hover:underline">√Öbn styling</a></p>';
      }
      document.getElementById('settings-global').innerHTML = globalHtml;

      // Metric cards
      document.getElementById('stat-events-total').textContent = (events.total || 0).toLocaleString('da-DK');
      document.getElementById('stat-events-today').textContent = (events.today || 0).toLocaleString('da-DK');
      document.getElementById('stat-sessions-total').textContent = (sessions.total || 0).toLocaleString('da-DK');
      document.getElementById('stat-avg-pages').textContent = sessions.avg_pages != null ? sessions.avg_pages : '‚Äî';

      // Top events
      var html = '';
      (events.top_events || []).forEach(function(ev) {
        html += '<tr class="border-b border-gray-100">'
          + '<td class="py-2">' + esc(ev.event_name) + '</td>'
          + '<td class="py-2"><span class="inline-block px-2 py-0.5 rounded text-xs bg-gray-100">' + esc(ev.event_type) + '</span></td>'
          + '<td class="py-2 text-right font-medium">' + ev.count + '</td>'
          + '</tr>';
      });
      document.getElementById('table-top-events').innerHTML = html;

      // Top landing pages
      html = '';
      (sessions.top_pages || []).forEach(function(p) {
        html += '<tr class="border-b border-gray-100">'
          + '<td class="py-2 font-mono text-xs">' + esc(p.first_page) + '</td>'
          + '<td class="py-2 text-right font-medium">' + p.count + '</td>'
          + '</tr>';
      });
      document.getElementById('table-top-pages').innerHTML = html;

      // Recent events
      html = '';
      (events.recent || []).forEach(function(ev) {
        html += '<tr class="border-b border-gray-100">'
          + '<td class="py-2"><span class="inline-block px-2 py-0.5 rounded text-xs bg-gray-100">' + esc(ev.event_type) + '</span></td>'
          + '<td class="py-2">' + esc(ev.event_name) + '</td>'
          + '<td class="py-2 font-mono text-xs">' + esc(ev.page_url) + '</td>'
          + '<td class="py-2 text-gray-500 text-xs whitespace-nowrap">' + fmt(ev.created_at) + '</td>'
          + '</tr>';
      });
      document.getElementById('table-recent-events').innerHTML = html;

      // Show dashboard
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
    })
    .catch(function(err) {
      if (err.message === 'Unauthorized') return;
      document.getElementById('loading').classList.add('hidden');
      var msg = err.message === 'Failed to fetch'
        ? ('Kunne ikke forbinde til API (' + API + '). Tjek om serveren k√∏rer.')
        : (err.message.indexOf('503') >= 0 ? err.message : 'Kunne ikke hente data: ' + err.message);
      document.getElementById('error-text').textContent = msg;
      document.getElementById('error').classList.remove('hidden');
    });

    document.getElementById('dashboard-publish-btn')?.addEventListener('click', function() {
      var btn = this;
      btn.disabled = true;
      btn.textContent = 'Starter...';
      fetch(API + '/publish', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
      }).then(function(res) { return res.json().then(function(d) { return { ok: res.ok, data: d }; }); })
        .then(function(r) {
          if (r.ok) {
            btn.textContent = '‚úì Udrulning startet';
            btn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
            btn.classList.add('bg-green-600');
          } else {
            throw new Error(r.data.error || 'Fejl');
          }
        })
        .catch(function(err) {
          alert('Fejl: ' + err.message);
          btn.textContent = 'Publicer til live (~90 sek)';
        })
        .finally(function() {
          btn.disabled = false;
        });
    });
  })();
  })();</script>  </main> </div> </div> <!-- Sidebar/header visibility + logout --> <script>
    (function() {
      var path = window.location.pathname.replace(/\/$/, '') || '/admin';
      if (path === '/admin') return;

      // Show sidebar and header on dashboard pages
      var sidebar = document.getElementById('admin-sidebar');
      var header = document.getElementById('admin-header');
      if (sidebar) { sidebar.classList.remove('hidden'); sidebar.classList.add('lg:flex'); }
      if (header) { header.classList.remove('hidden'); header.classList.add('flex'); }

      // Show admin email from JWT; hide Master Hub for non-master
      try {
        var token = localStorage.getItem('admin_token');
        if (token) {
          var payload = JSON.parse(atob(token.split('.')[1]));
          var emailEl = document.getElementById('admin-email');
          if (emailEl) emailEl.textContent = payload.email || '';
          var masterLink = document.getElementById('master-hub-link');
          if (masterLink && payload.role !== 'master') {
            masterLink.style.display = 'none';
          }
        }
      } catch(e) {}

      // Logout
      var logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          localStorage.removeItem('admin_token');
          window.location.href = '/admin/';
        });
      }

      // Mobile menu toggle
      var menuBtn = document.getElementById('mobile-menu-btn');
      if (menuBtn && sidebar) {
        menuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('fixed');
          sidebar.classList.toggle('z-50');
          sidebar.classList.toggle('inset-0');
          sidebar.classList.toggle('flex');
        });
      }

      // Highlight active nav item
      var normalizedPath = path.replace(/\/$/, '') || '/admin';
      var links = sidebar ? sidebar.querySelectorAll('nav a[href]') : [];
      links.forEach(function(a) {
        var href = a.getAttribute('href') || '';
        var linkPath = href.replace(/\/$/, '') || '/admin';
        if (normalizedPath === linkPath) {
          a.classList.add('bg-gray-800', 'text-white');
          a.classList.remove('hover:bg-gray-800');
        }
      });
    })();
    </script>  </body></html>
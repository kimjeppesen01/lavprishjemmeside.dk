---
interface Props {
  headline?: string;
  description?: string;
  updateText?: string;
  stats: Array<{ value: string; label: string; icon?: string; highlight?: boolean; pct?: number }>;
  infoItems?: string[];
  backgroundColor?: 'default' | 'primary' | 'alt';
  version?: 'cards' | 'inline';
  instanceId?: string | number;
}

const {
  headline,
  description,
  updateText,
  stats = [],
  infoItems = [],
  backgroundColor = 'default',
  version = 'cards',
  instanceId = 'default',
} = Astro.props;

const bgClass =
  backgroundColor === 'primary'
    ? 'bg-[var(--color-primary)]'
    : backgroundColor === 'alt'
      ? 'bg-[var(--color-bg-section-alt)]'
      : '';

const hasIntro = headline || description || updateText;
const isInline = version === 'inline';
---

<section
  class={`py-[var(--section-padding-y)] px-[var(--container-padding-x)] ${bgClass}`}
  aria-label="Nøgletal"
>
  <div class="mx-auto max-w-[var(--container-max-width)]">
    {isInline ? (
      <div class="flex flex-wrap items-center justify-center gap-x-8 gap-y-4 md:gap-x-12" data-reveal>
        {headline && (
          <h2
            class="text-[var(--font-size-lg)] font-bold text-[var(--color-text-primary)] md:text-[var(--font-size-xl)] shrink-0"
            style="font-family: var(--font-heading)"
          >
            {headline}
          </h2>
        )}
        {stats.map((stat, i) => (
          <div
            class="stats-inline-item relative flex items-baseline gap-2 shrink-0"
            role="listitem"
            style={`--reveal-delay: ${i * 60}ms`}
            data-reveal
          >
            {i > 0 && (
              <span class="text-[var(--color-text-secondary)]/50" aria-hidden="true">•</span>
            )}
            {/* Progress bar track behind the stat */}
            {stat.pct !== undefined && (
              <div
                class="stats-progress-bar"
                style={`width: ${Math.min(100, Math.max(0, stat.pct))}%`}
                aria-hidden="true"
              ></div>
            )}
            <span
              class="stat-number stat-number--hover text-[var(--font-size-2xl)] font-bold tabular-nums text-[var(--color-primary)] md:text-[var(--font-size-3xl)]"
              style={`font-family: var(--font-heading); animation-delay: ${i * 0.06}s`}
              data-count-up={/^\d[\d,]*[\+%]?$/.test(stat.value.replace(/,/g, '')) ? stat.value.replace(/,/g, '') : undefined}
            >
              {stat.value}
            </span>
            <span
              class="text-[var(--font-size-sm)] text-[var(--color-text-secondary)]"
              style="font-family: var(--font-body)"
            >
              {stat.label}
            </span>
          </div>
        ))}
      </div>
    ) : (
      <div class="flex flex-col lg:flex-row lg:gap-12 xl:gap-16">
        {hasIntro && (
          <div class="lg:w-2/5 shrink-0 mb-8 lg:mb-0" data-reveal>
            {headline && (
              <h2
                class="text-[var(--font-size-2xl)] font-bold text-[var(--color-text-primary)] md:text-[var(--font-size-3xl)] leading-tight"
                style="font-family: var(--font-heading)"
              >
                {headline}
              </h2>
            )}
            {description && (
              <p
                class="mt-4 text-[var(--font-size-base)] text-[var(--color-text-secondary)]"
                style="font-family: var(--font-body)"
              >
                {description}
              </p>
            )}
          </div>
        )}

        <div class="flex-1 min-w-0">
          {updateText && (
            <p
              class="text-[var(--font-size-sm)] text-[var(--color-text-secondary)] mb-4"
              style="font-family: var(--font-body)"
            >
              {updateText}
            </p>
          )}

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 sm:gap-5" role="list">
            {stats.map((stat, i) => {
              const highlight = stat.highlight ?? (i === 0 && stats.length > 1);
              const cardClass = highlight
                ? 'stats-card--highlight bg-[var(--color-neutral-800)] text-white'
                : 'stats-card bg-[var(--color-bg-page)] border border-[var(--color-border)]';
              const valueClass = highlight ? 'text-white' : 'text-[var(--color-primary)]';
              const labelClass = highlight ? 'text-white/80' : 'text-[var(--color-text-secondary)]';
              return (
                <div
                  class={`stats-card-wrap relative overflow-hidden rounded-[var(--radius-card)] p-5 sm:p-6 flex flex-col justify-center items-center text-center transition-all duration-200 hover:-translate-y-0.5 hover:shadow-[var(--shadow-md)] ${cardClass}`}
                  role="listitem"
                  data-reveal
                  style={`--reveal-delay: ${i * 70}ms`}
                >
                  {/* Gradient top accent line */}
                  <div class="stats-top-line" aria-hidden="true"></div>

                  {/* Progress bar fill (if pct provided) */}
                  {stat.pct !== undefined && (
                    <div
                      class="stats-progress-bar"
                      style={`width: ${Math.min(100, Math.max(0, stat.pct))}%`}
                      aria-hidden="true"
                    ></div>
                  )}

                  {stat.icon && (
                    <div class="icon-wrap mb-3" aria-hidden="true">{stat.icon}</div>
                  )}
                  <div
                    class={`stat-number stat-number--hover inline-block text-[var(--font-size-3xl)] font-bold tabular-nums sm:text-[var(--font-size-4xl)] md:text-[var(--font-size-5xl)] ${valueClass}`}
                    style={`font-family: var(--font-heading); animation-delay: ${i * 0.08}s`}
                    data-count-up={/^\d[\d,]*[\+%]?$/.test(stat.value.replace(/,/g, '')) ? stat.value.replace(/,/g, '') : undefined}
                  >
                    {stat.value}
                  </div>
                  <div class={`mt-2 text-[var(--font-size-sm)] ${labelClass}`} style="font-family: var(--font-body)">
                    {stat.label}
                  </div>
                </div>
              );
            })}
          </div>

          {infoItems.length > 0 && (
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
              {infoItems.map((item, i) => (
                <div
                  class="rounded-[var(--radius-card)] bg-[var(--color-bg-page)] border border-[var(--color-border)] px-5 py-4 text-center text-[var(--font-size-base)] font-medium text-[var(--color-text-primary)] transition-colors hover:border-[var(--color-primary)]/40"
                  style={`font-family: var(--font-body); --reveal-delay: ${i * 60}ms`}
                  data-reveal
                >
                  {item}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    )}
  </div>
</section>

<style>
/* Gradient top accent line on cards */
.stats-top-line {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  border-radius: var(--radius-card) var(--radius-card) 0 0;
  background: var(--gradient-brand, var(--color-primary));
  opacity: 0.6;
}
.stats-card--highlight .stats-top-line {
  opacity: 1;
}

/* Subtle progress bar fill (behind content) */
.stats-progress-bar {
  position: absolute;
  inset: 0 auto 0 0;
  background: color-mix(in srgb, var(--color-primary) 5%, transparent);
  border-radius: inherit;
  pointer-events: none;
  transition: width 800ms var(--motion-ease-enter, cubic-bezier(0, 0, 0.2, 1));
}

/* Inline variant item: relative container for progress bar */
.stats-inline-item {
  position: relative;
}
</style>

<script>
  function formatWithCommas(n: number): string {
    return n.toLocaleString('da-DK');
  }

  function runCountUp(el: Element) {
    const raw = el.getAttribute('data-count-up');
    if (!raw) return;
    const match = raw.match(/^(\d+)([\+%]?)$/);
    if (!match) return;
    const target = parseInt(match[1], 10);
    const suffix = match[2] || '';
    const duration = 1200;
    const start = performance.now();
    el.textContent = '0' + suffix;

    function tick(now: number) {
      const elapsed = now - start;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.floor(eased * target);
      // Format with commas for numbers >= 1000
      el.textContent = (target >= 1000 ? formatWithCommas(current) : String(current)) + suffix;
      if (progress < 1) requestAnimationFrame(tick);
      else el.textContent = (target >= 1000 ? formatWithCommas(target) : String(target)) + suffix;
    }
    requestAnimationFrame(tick);
  }

  function initCountUp() {
    const els = document.querySelectorAll('.stat-number[data-count-up]');
    if (els.length === 0) return;
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      els.forEach(function(el) {
        const raw = el.getAttribute('data-count-up');
        if (raw) {
          const match = raw.match(/^(\d+)([\+%]?)$/);
          if (match) {
            const n = parseInt(match[1], 10);
            el.textContent = (n >= 1000 ? formatWithCommas(n) : String(n)) + (match[2] || '');
          } else {
            el.textContent = raw;
          }
        }
        el.removeAttribute('data-count-up');
      });
      return;
    }
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.target.hasAttribute('data-count-up')) {
            runCountUp(entry.target);
            entry.target.removeAttribute('data-count-up');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2, rootMargin: '0px 0px -50px 0px' }
    );
    els.forEach((el) => observer.observe(el));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountUp);
  } else {
    initCountUp();
  }
</script>

---
interface Props {
  headline?: string;
  description?: string;
  updateText?: string;
  stats: Array<{ value: string; label: string; icon?: string; highlight?: boolean }>;
  infoItems?: string[];
  backgroundColor?: 'default' | 'primary' | 'alt';
  version?: 'cards' | 'inline';
  instanceId?: string | number;
}

const {
  headline,
  description,
  updateText,
  stats = [],
  infoItems = [],
  backgroundColor = 'default',
  version = 'cards',
  instanceId = 'default',
} = Astro.props;

const bgClass =
  backgroundColor === 'primary'
    ? 'bg-[var(--color-primary)]'
    : backgroundColor === 'alt'
      ? 'bg-[var(--color-bg-section-alt)]'
      : '';

const hasIntro = headline || description || updateText;
const isInline = version === 'inline';
---

<section
  class={`py-[var(--section-padding-y)] px-[var(--container-padding-x)] ${bgClass}`}
  aria-label="Nøgletal"
>
  <div class="mx-auto max-w-[var(--container-max-width)]">
    {isInline ? (
      <div class="flex flex-wrap items-center justify-center gap-x-8 gap-y-4 md:gap-x-12">
        {headline && (
          <h2
            class="text-[var(--font-size-lg)] font-bold text-[var(--color-text-primary)] md:text-[var(--font-size-xl)] shrink-0"
            style="font-family: var(--font-heading)"
          >
            {headline}
          </h2>
        )}
        {stats.map((stat, i) => (
          <div
            class="flex items-baseline gap-2 shrink-0"
            role="listitem"
          >
            {i > 0 && (
              <span class="text-[var(--color-text-secondary)]/50" aria-hidden="true">•</span>
            )}
            <span
              class="stat-number stat-number--hover text-[var(--font-size-2xl)] font-bold tabular-nums text-[var(--color-primary)] md:text-[var(--font-size-3xl)]"
              style={`font-family: var(--font-heading); animation-delay: ${i * 0.06}s`}
              data-count-up={/^\d+[\+%]?$/.test(stat.value) ? stat.value : undefined}
            >
              {stat.value}
            </span>
            <span
              class="text-[var(--font-size-sm)] text-[var(--color-text-secondary)]"
              style="font-family: var(--font-body)"
            >
              {stat.label}
            </span>
          </div>
        ))}
      </div>
    ) : (
      <div class="flex flex-col lg:flex-row lg:gap-12 xl:gap-16">
        {hasIntro && (
          <div class="lg:w-2/5 shrink-0 mb-8 lg:mb-0">
            {headline && (
              <h2
                class="text-[var(--font-size-2xl)] font-bold text-[var(--color-text-primary)] md:text-[var(--font-size-3xl)] leading-tight"
                style="font-family: var(--font-heading)"
              >
                {headline}
              </h2>
            )}
            {description && (
              <p
                class="mt-4 text-[var(--font-size-base)] text-[var(--color-text-secondary)]"
                style="font-family: var(--font-body)"
              >
                {description}
              </p>
            )}
          </div>
        )}

        <div class="flex-1 min-w-0">
          {updateText && (
            <p
              class="text-[var(--font-size-sm)] text-[var(--color-text-secondary)] mb-4"
              style="font-family: var(--font-body)"
            >
              {updateText}
            </p>
          )}

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 sm:gap-5" role="list">
            {stats.map((stat, i) => {
              const highlight = stat.highlight ?? (i === 0 && stats.length > 1);
              const cardClass = highlight
                ? 'bg-[var(--color-neutral-800)] text-white'
                : 'bg-[var(--color-bg-page)] border border-[var(--color-border)]';
              const valueClass = highlight ? 'text-white' : 'text-[var(--color-primary)]';
              const labelClass = highlight ? 'text-white/80' : 'text-[var(--color-text-secondary)]';
              return (
                <div
                  class={`rounded-[var(--radius-card)] p-5 sm:p-6 flex flex-col justify-center items-center text-center ${cardClass}`}
                  role="listitem"
                >
                  {stat.icon && (
                    <span class="mb-2 text-2xl" aria-hidden="true">{stat.icon}</span>
                  )}
                  <div
                    class={`stat-number stat-number--hover inline-block text-[var(--font-size-3xl)] font-bold tabular-nums sm:text-[var(--font-size-4xl)] md:text-[var(--font-size-5xl)] ${valueClass}`}
                    style={`font-family: var(--font-heading); animation-delay: ${i * 0.08}s`}
                    data-count-up={/^\d+[\+%]?$/.test(stat.value) ? stat.value : undefined}
                  >
                    {stat.value}
                  </div>
                  <div class={`mt-2 text-[var(--font-size-sm)] ${labelClass}`} style="font-family: var(--font-body)">
                    {stat.label}
                  </div>
                </div>
              );
            })}
          </div>

          {infoItems.length > 0 && (
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
              {infoItems.map((item) => (
                <div
                  class="rounded-[var(--radius-card)] bg-[var(--color-bg-page)] border border-[var(--color-border)] px-5 py-4 text-center text-[var(--font-size-base)] font-medium text-[var(--color-text-primary)]"
                  style="font-family: var(--font-body)"
                >
                  {item}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    )}
  </div>
</section>

<script>
  function runCountUp(el) {
    const raw = el.getAttribute('data-count-up');
    if (!raw) return;
    const match = raw.match(/^(\d+)([\+%]?)$/);
    if (!match) return;
    const target = parseInt(match[1], 10);
    const suffix = match[2] || '';
    const duration = 1200;
    const start = performance.now();
    el.textContent = '0' + suffix;

    function tick(now) {
      const elapsed = now - start;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.floor(eased * target);
      el.textContent = current + suffix;
      if (progress < 1) requestAnimationFrame(tick);
      else el.textContent = raw;
    }
    requestAnimationFrame(tick);
  }

  function initCountUp() {
    const els = document.querySelectorAll('.stat-number[data-count-up]');
    if (els.length === 0) return;
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.target.hasAttribute('data-count-up')) {
            runCountUp(entry.target);
            entry.target.removeAttribute('data-count-up');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2, rootMargin: '0px 0px -50px 0px' }
    );
    els.forEach((el) => observer.observe(el));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountUp);
  } else {
    initCountUp();
  }
</script>

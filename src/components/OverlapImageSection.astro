---
/**
 * Overlap Image Section â€” Text + image where the visual extends into the next section.
 */
import { buildSrcset } from '../utils/image';

interface Props {
  headline: string;
  content: string;
  imageUrl: string;
  imageAlt?: string;
  imagePlacement?: 'left' | 'right' | 'center';
  overlapAmount?: number;
  backgroundColor?: 'default' | 'primary' | 'alt';
  bottomDivider?: 'straight' | 'wave';
  bulletPoints?: string[];
  cta?: { text: string; href: string };
  instanceId?: string | number;
  /** Passed by page wrapper for wave divider to blend into next section */
  nextSectionBg?: 'page' | 'alt';
}

const {
  headline,
  content,
  imageUrl,
  imageAlt,
  imagePlacement = 'right',
  overlapAmount = 80,
  backgroundColor = 'default',
  bottomDivider = 'straight',
  bulletPoints = [],
  cta,
  instanceId = 'default',
  nextSectionBg,
} = Astro.props;

const headingId = `overlap-image-heading-${instanceId}`;
const imgSrcset = buildSrcset(imageUrl, [600, 900, 1200]);

const bgClass =
  backgroundColor === 'primary'
    ? 'bg-[var(--color-primary)]'
    : backgroundColor === 'alt'
      ? 'bg-[var(--color-bg-section-alt)]'
      : '';

const textLight = backgroundColor === 'primary';
const textClass = textLight
  ? 'text-white'
  : 'text-[var(--color-text-primary)]';
const textSecondaryClass = textLight
  ? 'text-white/90'
  : 'text-[var(--color-text-secondary)]';

const overlapPx = Math.min(Math.max(overlapAmount || 0, 0), 150);
const waveFill =
  backgroundColor === 'primary'
    ? 'var(--color-primary)'
    : backgroundColor === 'alt'
      ? 'var(--color-bg-section-alt)'
      : nextSectionBg === 'alt'
        ? 'var(--color-bg-section-alt)'
        : 'var(--color-bg-page)';
---

<>
<section
  class={`relative z-10 overflow-visible py-[var(--section-padding-y)] px-[var(--container-padding-x)] ${bgClass}`}
  aria-labelledby={headingId}
>
  <div class="mx-auto max-w-[var(--container-max-width)]">
    <div
      class:list={[
        'grid gap-8 lg:gap-12',
        imagePlacement === 'center'
          ? 'grid-cols-1'
          : 'grid-cols-1 lg:grid-cols-2 lg:items-center',
      ]}
    >
      {imagePlacement === 'left' && (
        <div class="order-2 lg:order-1">
          <div
            class="relative overflow-hidden rounded-[var(--radius-lg)] shadow-[var(--shadow-lg)]"
            style={`margin-bottom: -${overlapPx}px`}
          >
            <img
              src={imageUrl}
              srcset={imgSrcset}
              sizes="(max-width: 1024px) 100vw, 50vw"
              alt={imageAlt || headline}
              class="h-auto w-full object-cover"
              loading="lazy"
            />
          </div>
        </div>
      )}

      <div
        id={headingId}
        class:list={[
          'order-1 flex flex-col justify-center lg:order-2',
          imagePlacement === 'center' && 'text-center',
        ]}
      >
        <h2
          class={`text-[var(--font-size-2xl)] font-bold md:text-[var(--font-size-3xl)] ${textClass}`}
          style="font-family: var(--font-heading)"
        >
          {headline}
        </h2>
        <div
          class={`mt-4 text-[var(--font-size-base)] leading-[var(--line-height-normal)] ${textSecondaryClass} [&>p]:mt-4 [&>p:first-child]:mt-0`}
          style="font-family: var(--font-body)"
          set:html={content}
        />
        {bulletPoints.length > 0 && (
          <ul class="mt-6 space-y-2" role="list">
            {bulletPoints.map((item) => (
              <li
                class={`flex items-start gap-2 text-[var(--font-size-base)] ${textSecondaryClass}`}
                style="font-family: var(--font-body)"
              >
                <span class="mt-1.5 h-2 w-2 shrink-0 rounded-full bg-[var(--color-primary)]" aria-hidden="true" />
                {item}
              </li>
            ))}
          </ul>
        )}
        {cta && (
          <div class="mt-6">
            <a
              href={cta.href}
              class="inline-flex min-h-[44px] min-w-[44px] items-center justify-center rounded-[var(--radius-button)] border-2 px-6 py-3 text-[var(--font-size-base)] font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2"
              class:list={[
                textLight
                  ? 'border-white bg-white/10 text-white hover:bg-white/20 focus:ring-white'
                  : 'border-[var(--color-primary)] text-[var(--color-primary)] hover:bg-[var(--color-primary-light)] focus:ring-[var(--color-primary)]',
              ]}
              style="font-family: var(--font-body)"
            >
              {cta.text}
            </a>
          </div>
        )}
      </div>

      {imagePlacement === 'right' && (
        <div class="relative">
          <div
            class="relative overflow-hidden rounded-[var(--radius-lg)] shadow-[var(--shadow-lg)]"
            style={`margin-bottom: -${overlapPx}px`}
          >
            <img
              src={imageUrl}
              srcset={imgSrcset}
              sizes="(max-width: 1024px) 100vw, 50vw"
              alt={imageAlt || headline}
              class="h-auto w-full object-cover"
              loading="lazy"
            />
          </div>
        </div>
      )}

      {imagePlacement === 'center' && (
        <div class="relative">
          <div
            class="relative mx-auto max-w-2xl overflow-hidden rounded-[var(--radius-lg)] shadow-[var(--shadow-lg)]"
            style={`margin-bottom: -${overlapPx}px`}
          >
            <img
              src={imageUrl}
              srcset={imgSrcset}
              sizes="(max-width: 1024px) 100vw, 672px"
              alt={imageAlt || headline}
              class="h-auto w-full object-cover"
              loading="lazy"
            />
          </div>
        </div>
      )}
    </div>
  </div>

  {bottomDivider === 'wave' && (
    <div
      class="absolute bottom-0 left-0 right-0 h-12 overflow-hidden pointer-events-none"
      aria-hidden="true"
    >
      <svg
        class="absolute bottom-0 w-full"
        viewBox="0 0 1200 120"
        preserveAspectRatio="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill={waveFill}
          d="M0,60 C300,120 900,0 1200,60 L1200,120 L0,120 Z"
        />
      </svg>
    </div>
  )}
</section>
{overlapPx > 0 && (
  <div
    class="overlap-spacer"
    style={`height: ${overlapPx}px`}
    aria-hidden="true"
  />
)}
</>

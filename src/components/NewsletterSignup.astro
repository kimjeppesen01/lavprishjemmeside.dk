---
interface Props {
  headline: string;
  description?: string;
  placeholder?: string;
  buttonText?: string;
  privacyText?: string;
  layout?: 'inline' | 'card';
  instanceId?: string | number;
}

const {
  headline = 'Nyhedsbrev',
  description,
  placeholder = 'Din e-mail',
  buttonText = 'Tilmeld',
  privacyText = 'Vi deler aldrig din e-mail med tredjeparter. Du kan afmelde dig når som helst.',
  layout = 'inline',
  instanceId = 'default',
} = Astro.props;
const headingId = `newsletter-heading-${instanceId}`;
const isCard = layout === 'card';
---

<section
  class:list={[
    'py-[var(--section-padding-y)] px-[var(--container-padding-x)]',
    isCard && 'modern-shell',
  ]}
  aria-labelledby={headingId}
>
  <div class="mx-auto max-w-[var(--container-max-width)]">
    {isCard ? (
      /* Card variant: centered gradient card */
      <div class="newsletter-card mx-auto max-w-2xl rounded-[var(--radius-card)] p-10 text-center" data-reveal>
        <span class="eyebrow eyebrow--on-gradient">Bliv opdateret</span>
        <h2
          id={headingId}
          class="heading-fluid mt-3 font-bold text-white"
          style="font-family: var(--font-heading)"
        >
          {headline}
        </h2>
        {description && (
          <p
            class="mx-auto mt-4 max-w-md text-[var(--font-size-base)] text-white/80"
            style="font-family: var(--font-body)"
          >
            {description}
          </p>
        )}
        <form
          id={`newsletter-form-${instanceId}`}
          class="newsletter-form-joined mt-8 flex flex-col gap-0 sm:flex-row"
          method="post"
          action="/api/newsletter"
        >
          <label for={`newsletter-email-${instanceId}`} class="sr-only">{placeholder}</label>
          <input
            type="email"
            id={`newsletter-email-${instanceId}`}
            name="email"
            required
            placeholder={placeholder}
            autocomplete="email"
            class="min-h-[48px] flex-1 rounded-l-[var(--radius-full)] rounded-r-none border-0 px-5 py-3 text-[var(--font-size-base)] text-[var(--color-text-primary)] bg-white/95 placeholder:text-[var(--color-text-secondary)] focus:outline-none focus:ring-2 focus:ring-white/50"
            style="font-family: var(--font-body)"
          />
          <button
            type="submit"
            class="newsletter-btn min-h-[48px] shrink-0 rounded-l-none rounded-r-[var(--radius-full)] bg-[var(--color-text-primary)] px-6 py-3 text-[var(--font-size-base)] font-semibold text-white transition-opacity hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-white/50 sm:rounded-l-none"
            style="font-family: var(--font-body)"
          >
            {buttonText}
          </button>
        </form>
        {privacyText && (
          <p class="mt-4 text-xs text-white/60" style="font-family: var(--font-body)">
            {privacyText}
          </p>
        )}
        <div
          id={`newsletter-success-${instanceId}`}
          class="newsletter-success hidden mt-6 rounded-[var(--radius-card)] bg-white/20 px-6 py-4 text-white font-medium"
          role="status"
          aria-live="polite"
          style="font-family: var(--font-body)"
        >
          ✓ Du er nu tilmeldt!
        </div>
      </div>
    ) : (
      /* Inline variant */
      <div data-reveal>
        <h2
          id={headingId}
          class="heading-fluid font-bold text-[var(--color-text-primary)]"
          style="font-family: var(--font-heading)"
        >
          {headline}
        </h2>
        {description && (
          <p
            class="mt-2 text-[var(--font-size-base)] text-[var(--color-text-secondary)]"
            style="font-family: var(--font-body)"
          >
            {description}
          </p>
        )}
        <form
          id={`newsletter-form-${instanceId}`}
          class="newsletter-form-joined mt-6 flex flex-col gap-0 sm:flex-row"
          method="post"
          action="/api/newsletter"
        >
          <label for={`newsletter-email-${instanceId}`} class="sr-only">{placeholder}</label>
          <input
            type="email"
            id={`newsletter-email-${instanceId}`}
            name="email"
            required
            placeholder={placeholder}
            autocomplete="email"
            class="min-h-[48px] flex-1 rounded-l-[var(--radius-full)] rounded-r-none border border-r-0 border-[var(--color-border)] bg-[var(--color-bg-page)] px-5 py-3 text-[var(--font-size-base)] text-[var(--color-text-primary)] placeholder:text-[var(--color-text-secondary)] focus:border-[var(--color-primary)] focus:outline-none focus:ring-1 focus:ring-[var(--color-primary)]"
            style="font-family: var(--font-body)"
          />
          <button
            type="submit"
            class="newsletter-btn focus-modern min-h-[48px] shrink-0 rounded-l-none rounded-r-[var(--radius-full)] btn-gradient px-6 py-3 text-[var(--font-size-base)] font-semibold text-[var(--color-text-on-primary)] transition-opacity hover:opacity-90"
            style="font-family: var(--font-body)"
          >
            {buttonText}
          </button>
        </form>
        {privacyText && (
          <p
            class="mt-3 text-[var(--font-size-sm)] text-[var(--color-text-secondary)]"
            style="font-family: var(--font-body)"
          >
            {privacyText}
          </p>
        )}
        <div
          id={`newsletter-success-${instanceId}`}
          class="newsletter-success hidden mt-4 rounded-[var(--radius-card)] border border-[var(--color-primary)]/20 bg-[var(--color-primary-light)] px-5 py-3 text-[var(--font-size-base)] font-medium text-[var(--color-text-primary)]"
          role="status"
          aria-live="polite"
          style="font-family: var(--font-body)"
        >
          ✓ Du er nu tilmeldt!
        </div>
      </div>
    )}
  </div>
</section>

<style>
/* Card variant: gradient background */
.newsletter-card {
  background: var(--gradient-brand, var(--color-primary));
  box-shadow: var(--shadow-lg, 0 20px 40px rgba(0,0,0,0.15));
}
.eyebrow--on-gradient {
  color: rgba(255,255,255,0.8);
  border-color: rgba(255,255,255,0.3);
}

/* Joined input+button: seamless pair */
.newsletter-form-joined {
  border-radius: var(--radius-full);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.newsletter-form-joined input,
.newsletter-form-joined button {
  border-radius: 0;
}
.newsletter-form-joined input:first-child {
  border-radius: var(--radius-full) 0 0 var(--radius-full);
}
.newsletter-form-joined button:last-child {
  border-radius: 0 var(--radius-full) var(--radius-full) 0;
}
@media (max-width: 640px) {
  .newsletter-form-joined input:first-child,
  .newsletter-form-joined button:last-child {
    border-radius: var(--radius-full);
  }
}

/* Success slide-up */
.newsletter-success:not(.hidden) {
  animation: modal-enter 400ms var(--motion-ease-enter, cubic-bezier(0, 0, 0.2, 1)) forwards;
}
@media (prefers-reduced-motion: reduce) {
  .newsletter-success:not(.hidden) { animation: none; }
}
</style>

<script is:inline define:vars={{ instanceId }}>
  (function() {
    var form = document.getElementById('newsletter-form-' + instanceId);
    var success = document.getElementById('newsletter-success-' + instanceId);
    if (!form) return;
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var btn = form.querySelector('.newsletter-btn');
      if (btn) { btn.disabled = true; btn.style.opacity = '0.7'; }
      var data = new FormData(form);
      fetch(form.action, { method: 'POST', body: data })
        .then(function() {
          form.classList.add('hidden');
          if (success) success.classList.remove('hidden');
        })
        .catch(function() {
          if (btn) { btn.disabled = false; btn.style.opacity = ''; }
        });
    });
  })();
</script>

---
/**
 * Stripe-style morphing mega menu.
 * Props: menu (array of { id, title, sections: [{ heading, links: [{ label, href }] }] })
 *        logoUrl, logoText, ctaLinks (optional [{ href, label }] for right-side buttons)
 */
interface Props {
  menu: Array<{
    id: string;
    title: string;
    sections: Array<{
      heading: string;
      links: Array<{ label: string; href: string }>;
    }>;
  }>;
  logoUrl?: string;
  logoText?: string;
  ctaLinks?: Array<{ href: string; label: string }>;
}

const siteName = typeof import.meta.env.PUBLIC_SITE_URL === 'string' && import.meta.env.PUBLIC_SITE_URL ? new URL(import.meta.env.PUBLIC_SITE_URL).hostname : 'lavprishjemmeside.dk';
const { menu = [], logoUrl = '/favicon.svg', logoText = siteName, ctaLinks = [] } = Astro.props;

// Ensure we have at least one category for the dropdown to work
const menuItems = Array.isArray(menu) && menu.length > 0
  ? menu
  : [
      {
        id: 'ydelser',
        title: 'Ydelser',
        sections: [
          {
            heading: 'Tjenester',
            links: [
              { label: 'Webbureau', href: '/ydelser/webbureau' },
              { label: 'SEO', href: '/ydelser/seo' },
              { label: 'Hosting', href: '/ydelser/hosting' },
            ],
          },
        ],
      },
      {
        id: 'pages',
        title: 'Sider',
        sections: [
          {
            heading: 'Sider',
            links: [
              { label: 'Forside', href: '/' },
              { label: 'Priser', href: '/priser' },
              { label: 'Om os', href: '/om-os' },
              { label: 'Kontakt', href: '/kontakt' },
            ],
          },
        ],
      },
    ];
---

<nav class="mega-menu-nav relative z-50 glass-surface border-b border-[var(--color-border)] transition-all duration-300" aria-label="Hovednavigation">
  <!-- Top nav bar -->
  <div class="mx-auto max-w-[var(--container-max-width)] flex items-center justify-between px-[var(--container-padding-x)] py-3 md:py-4">
    <a href="/" class="flex items-center gap-2 shrink-0" aria-label="Forside">
      <img src={logoUrl} alt="" class="h-8 w-auto hidden sm:block" width="32" height="32" />
      <span class="ml-1 font-semibold text-xl text-[var(--color-primary)]">{logoText}</span>
    </a>

    <!-- Desktop menu -->
    <ul class="hidden md:flex md:items-center md:gap-1">
      {menuItems.map((item, idx) => (
        <li class="mega-nav-item relative">
          <button
            type="button"
            class="mega-nav-trigger flex items-center gap-1 py-2 px-3 text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:ring-offset-2 rounded-[var(--radius-md)]"
            data-dropdown-index={idx}
            aria-expanded="false"
            aria-haspopup="true"
            aria-controls={`mega-dropdown-${item.id}`}
          >
            {item.title}
            <svg class="mega-trigger-chevron w-4 h-4 transition-transform duration-200" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </li>
      ))}
      {ctaLinks.map((link) => (
        <li class="ml-2">
          <a href={link.href} class="focus-modern inline-flex min-h-[40px] items-center rounded-[var(--radius-full)] btn-gradient px-5 py-2 text-sm font-semibold text-[var(--color-text-on-primary)] shadow-[var(--shadow-sm)] transition-opacity hover:opacity-90">
            {link.label}
          </a>
        </li>
      ))}
      {ctaLinks.length === 0 && (
        <li class="ml-2">
          <a href="/kontakt" class="focus-modern inline-flex min-h-[40px] items-center rounded-[var(--radius-full)] btn-gradient px-5 py-2 text-sm font-semibold text-[var(--color-text-on-primary)] shadow-[var(--shadow-sm)] transition-opacity hover:opacity-90">
            Kontakt
          </a>
        </li>
      )}
    </ul>

    <!-- Mobile hamburger -->
    <button
      type="button"
      class="focus-modern md:hidden p-2 -mr-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-[var(--radius-md)]"
      aria-label="Åbn menu"
      aria-expanded="false"
      id="mega-mobile-toggle"
    >
      <span class="hamburger-icon" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
  </div>

  <!-- Morphing dropdown wrapper (desktop) -->
  <div class="mega-dropdown-wrapper hidden md:block absolute top-full left-0 w-full" id="mega-dropdown-area">
    <div
      class="mega-dropdown-bg relative transition-all duration-300 ease-out opacity-0 overflow-hidden"
      id="mega-dropdown-bg"
      style="height: 0;"
    >
      <div class="absolute inset-0 bg-[var(--color-bg-page)] shadow-[var(--shadow-lg)] border-t border-[var(--color-border)] rounded-b-xl" aria-hidden="true"></div>
      {menuItems.map((item, idx) => (
        <div
          id={`mega-dropdown-${item.id}`}
          class="mega-dropdown-panel absolute top-0 left-0 right-0 opacity-0 pointer-events-none transition-opacity duration-300 ease-out"
          data-dropdown-index={idx}
          role="region"
          aria-label={`${item.title} menu`}
        >
          <div class="grid grid-cols-2 md:grid-cols-3 gap-8 p-8 mx-auto max-w-[var(--container-max-width)]">
            {item.sections.map((section) => (
              <div>
                <h3 class="text-xs font-semibold uppercase text-[var(--color-text-secondary)] tracking-wider mb-3">{section.heading}</h3>
                <ul class="space-y-2">
                  {section.links.map((link) => (
                    <li>
                      <a
                        href={link.href}
                        class="block text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] transition-colors py-0.5"
                      >
                        {link.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mega-mobile-menu" class="md:hidden fixed inset-0 bg-[var(--color-bg-page)] p-6 pt-16 overflow-y-auto z-40 hidden" aria-hidden="true">
    <button
      type="button"
      class="focus-modern absolute top-4 right-4 p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-[var(--radius-md)]"
      aria-label="Luk menu"
      id="mega-mobile-close"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <div class="space-y-4">
      {menuItems.map((item) => (
        <details class="group border-b border-[var(--color-border)] pb-4">
          <summary class="flex justify-between items-center py-2 text-lg font-medium text-[var(--color-text-primary)] cursor-pointer list-none">
            {item.title}
            <span class="ml-2 transition-transform duration-200 group-open:rotate-180">
              <svg class="w-5 h-5 text-[var(--color-text-secondary)]" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" />
              </svg>
            </span>
          </summary>
          <ul class="pl-4 mt-2 space-y-2">
            {item.sections.flatMap((sec) => sec.links).map((link) => (
              <li>
                <a href={link.href} class="block py-1.5 text-base text-[var(--color-text-secondary)] hover:text-[var(--color-primary)]">
                  {link.label}
                </a>
              </li>
            ))}
          </ul>
        </details>
      ))}
    </div>
    <a href="/kontakt" class="focus-modern block w-full text-center py-4 mt-8 font-semibold text-[var(--color-text-on-primary)] btn-gradient rounded-[var(--radius-button)] transition-opacity hover:opacity-90">
      Kontakt
    </a>
  </div>
</nav>

<style>
/* Animated hamburger → X */
.hamburger-icon {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  width: 24px;
  height: 18px;
}
.hamburger-icon span {
  display: block;
  width: 100%;
  height: 2px;
  background: currentColor;
  border-radius: 2px;
  transition: transform 200ms ease, opacity 200ms ease;
  transform-origin: center;
}
button[aria-expanded="true"] .hamburger-icon span:nth-child(1) {
  transform: translateY(8px) rotate(45deg);
}
button[aria-expanded="true"] .hamburger-icon span:nth-child(2) {
  opacity: 0;
  transform: scaleX(0);
}
button[aria-expanded="true"] .hamburger-icon span:nth-child(3) {
  transform: translateY(-8px) rotate(-45deg);
}

/* Chevron rotates when dropdown is open */
.mega-nav-trigger[aria-expanded="true"] .mega-trigger-chevron {
  transform: rotate(180deg);
}

/* Scrolled state */
.mega-menu-nav.mega--scrolled {
  box-shadow: var(--shadow-md, 0 4px 20px rgba(0,0,0,0.1));
}

@media (prefers-reduced-motion: reduce) {
  .hamburger-icon span { transition: none; }
  .mega-trigger-chevron { transition: none; }
}
</style>

<script>
  (function initMegaMenu() {
    const nav = document.querySelector('.mega-menu-nav');
    const triggers = document.querySelectorAll('.mega-nav-trigger');
    const wrapper = document.getElementById('mega-dropdown-area');
    const bg = document.getElementById('mega-dropdown-bg');
    const panels = document.querySelectorAll('.mega-dropdown-panel');
    const mobileToggle = document.getElementById('mega-mobile-toggle');
    const mobileMenu = document.getElementById('mega-mobile-menu');
    const mobileClose = document.getElementById('mega-mobile-close');

    // Scroll-based shadow
    if (nav) {
      const toggleScrolled = () => nav.classList.toggle('mega--scrolled', window.scrollY > 8);
      window.addEventListener('scroll', toggleScrolled, { passive: true });
      toggleScrolled();
    }

    let activeIndex = null;
    let hideTimeout = null;

    function showDropdown(index) {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
      activeIndex = index;
      const panel = panels[index];
      if (!panel || !bg || !wrapper) return;

      panels.forEach((p) => {
        p.classList.add('opacity-0', 'pointer-events-none');
        p.classList.remove('opacity-100');
      });
      panel.classList.remove('opacity-0', 'pointer-events-none');
      panel.classList.add('opacity-100');
      const rect = panel.getBoundingClientRect();

      bg.style.width = rect.width + 'px';
      bg.style.height = rect.height + 'px';
      bg.style.minHeight = '0';
      bg.style.opacity = '1';
      bg.style.transform = 'translateX(' + rect.left + 'px)';

      triggers.forEach((t, i) => {
        t.setAttribute('aria-expanded', String(i === index));
      });
    }

    function hideDropdown() {
      hideTimeout = setTimeout(() => {
        activeIndex = null;
        if (bg) {
          bg.style.opacity = '0';
          bg.style.height = '0';
          bg.style.minHeight = '0';
        }
        panels.forEach((p) => {
          p.classList.add('opacity-0', 'pointer-events-none');
          p.classList.remove('opacity-100');
        });
        triggers.forEach((t) => t.setAttribute('aria-expanded', 'false'));
      }, 100);
    }

    triggers.forEach((btn, idx) => {
      btn.addEventListener('mouseenter', () => showDropdown(idx));
      btn.addEventListener('focus', () => showDropdown(idx));
      btn.addEventListener('mouseleave', hideDropdown);
      btn.addEventListener('blur', () => {
        setTimeout(hideDropdown, 150);
      });
    });

    wrapper?.addEventListener('mouseenter', () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
    });
    wrapper?.addEventListener('mouseleave', hideDropdown);
    wrapper?.addEventListener('focusout', () => setTimeout(hideDropdown, 150));

    // Mobile
    mobileToggle?.addEventListener('click', () => {
      const isOpen = mobileMenu?.classList.contains('hidden') === false;
      if (isOpen) {
        mobileMenu?.classList.add('hidden');
        mobileMenu?.setAttribute('aria-hidden', 'true');
        mobileToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      } else {
        mobileMenu?.classList.remove('hidden');
        mobileMenu?.setAttribute('aria-hidden', 'false');
        mobileToggle.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }
    });
    mobileClose?.addEventListener('click', () => {
      mobileMenu?.classList.add('hidden');
      mobileMenu?.setAttribute('aria-hidden', 'true');
      mobileToggle?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    });
    mobileMenu?.querySelectorAll('a').forEach((a) => {
      a.addEventListener('click', () => {
        mobileMenu?.classList.add('hidden');
        mobileToggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      });
    });
  })();
</script>

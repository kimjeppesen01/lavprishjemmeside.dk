---
/**
 * Stripe-style morphing mega menu.
 * Props: menu (array of { id, title, sections: [{ heading, links: [{ label, href }] }] })
 *        logoUrl, logoText, ctaLinks (optional [{ href, label }] for right-side buttons)
 */
interface Props {
  menu: Array<{
    id: string;
    title: string;
    sections: Array<{
      heading: string;
      links: Array<{ label: string; href: string }>;
    }>;
  }>;
  logoUrl?: string;
  logoText?: string;
  ctaLinks?: Array<{ href: string; label: string }>;
}

const siteName = typeof import.meta.env.PUBLIC_SITE_URL === 'string' && import.meta.env.PUBLIC_SITE_URL ? new URL(import.meta.env.PUBLIC_SITE_URL).hostname : 'lavprishjemmeside.dk';
const { menu = [], logoUrl = '/favicon.svg', logoText = siteName, ctaLinks = [] } = Astro.props;

// Ensure we have at least one category for the dropdown to work
const menuItems = Array.isArray(menu) && menu.length > 0
  ? menu
  : [
      {
        id: 'ydelser',
        title: 'Ydelser',
        sections: [
          {
            heading: 'Tjenester',
            links: [
              { label: 'Webbureau', href: '/ydelser/webbureau' },
              { label: 'SEO', href: '/ydelser/seo' },
              { label: 'Hosting', href: '/ydelser/hosting' },
            ],
          },
        ],
      },
      {
        id: 'pages',
        title: 'Sider',
        sections: [
          {
            heading: 'Sider',
            links: [
              { label: 'Forside', href: '/' },
              { label: 'Priser', href: '/priser' },
              { label: 'Om os', href: '/om-os' },
              { label: 'Kontakt', href: '/kontakt' },
            ],
          },
        ],
      },
    ];
---

<nav class="mega-menu-nav relative z-50 bg-white border-b border-gray-200" aria-label="Hovednavigation">
  <!-- Top nav bar -->
  <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3 md:py-4">
    <a href="/" class="flex items-center shrink-0" aria-label="Forside">
      <img src={logoUrl} alt="" class="h-8 w-auto hidden sm:block" width="32" height="32" />
      <span class="ml-2 font-semibold text-xl text-[var(--color-primary)]">{logoText}</span>
    </a>

    <!-- Desktop menu -->
    <ul class="hidden md:flex md:items-center md:gap-1 md:space-x-6">
      {menuItems.map((item, idx) => (
        <li class="mega-nav-item relative">
          <button
            type="button"
            class="mega-nav-trigger flex items-center gap-1 py-2 text-sm font-medium text-gray-700 hover:text-[var(--color-primary)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:ring-offset-2 rounded"
            data-dropdown-index={idx}
            aria-expanded="false"
            aria-haspopup="true"
            aria-controls={`mega-dropdown-${item.id}`}
          >
            {item.title}
            <svg class="w-4 h-4 transition-transform" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </li>
      ))}
      {ctaLinks.map((link) => (
        <li>
          <a href={link.href} class="text-sm font-medium text-gray-700 hover:text-[var(--color-primary)] transition-colors">
            {link.label}
          </a>
        </li>
      ))}
      {ctaLinks.length === 0 && (
        <li>
          <a href="/kontakt" class="inline-block bg-[var(--color-primary)] text-white px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
            Kontakt
          </a>
        </li>
      )}
    </ul>

    <!-- Mobile hamburger -->
    <button
      type="button"
      class="md:hidden p-2 -mr-2 text-gray-600 hover:text-gray-900 rounded-lg"
      aria-label="Ã…bn menu"
      id="mega-mobile-toggle"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>

  <!-- Morphing dropdown wrapper (desktop) -->
  <div class="mega-dropdown-wrapper hidden md:block absolute top-full left-0 w-full" id="mega-dropdown-area">
    <div
      class="mega-dropdown-bg relative transition-all duration-300 ease-out opacity-0 overflow-hidden"
      id="mega-dropdown-bg"
      style="height: 0;"
    >
      <div class="absolute inset-0 bg-white shadow-lg border-t border-gray-100 rounded-b-xl" aria-hidden="true"></div>
      {menuItems.map((item, idx) => (
        <div
          id={`mega-dropdown-${item.id}`}
          class="mega-dropdown-panel absolute top-0 left-0 right-0 opacity-0 pointer-events-none transition-opacity duration-300 ease-out"
          data-dropdown-index={idx}
          role="region"
          aria-label={`${item.title} menu`}
        >
          <div class="grid grid-cols-2 md:grid-cols-3 gap-8 p-8 max-w-6xl mx-auto">
            {item.sections.map((section) => (
              <div>
                <h3 class="text-xs font-semibold uppercase text-gray-500 tracking-wider mb-3">{section.heading}</h3>
                <ul class="space-y-2">
                  {section.links.map((link) => (
                    <li>
                      <a
                        href={link.href}
                        class="block text-sm text-gray-700 hover:text-[var(--color-primary)] transition-colors"
                      >
                        {link.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mega-mobile-menu" class="md:hidden fixed inset-0 bg-white p-6 pt-16 overflow-y-auto z-40 hidden" aria-hidden="true">
    <button
      type="button"
      class="absolute top-4 right-4 p-2 text-gray-600 hover:text-gray-900 rounded-lg"
      aria-label="Luk menu"
      id="mega-mobile-close"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <div class="space-y-4">
      {menuItems.map((item) => (
        <details class="group border-b border-gray-100 pb-4">
          <summary class="flex justify-between items-center py-2 text-lg font-medium text-gray-900 cursor-pointer list-none">
            {item.title}
            <span class="ml-2 transition-transform duration-200 group-open:rotate-180">
              <svg class="w-5 h-5 text-gray-500" viewBox="0 0 16 16" fill="none">
                <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" />
              </svg>
            </span>
          </summary>
          <ul class="pl-4 mt-2 space-y-2">
            {item.sections.flatMap((sec) => sec.links).map((link) => (
              <li>
                <a href={link.href} class="block py-1.5 text-base text-gray-700 hover:text-[var(--color-primary)]">
                  {link.label}
                </a>
              </li>
            ))}
          </ul>
        </details>
      ))}
    </div>
    <a href="/kontakt" class="block w-full text-center py-4 mt-8 font-semibold text-white bg-[var(--color-primary)] rounded-lg hover:opacity-90">
      Kontakt
    </a>
  </div>
</nav>

<script>
  (function initMegaMenu() {
    const triggers = document.querySelectorAll('.mega-nav-trigger');
    const wrapper = document.getElementById('mega-dropdown-area');
    const bg = document.getElementById('mega-dropdown-bg');
    const panels = document.querySelectorAll('.mega-dropdown-panel');
    const mobileToggle = document.getElementById('mega-mobile-toggle');
    const mobileMenu = document.getElementById('mega-mobile-menu');
    const mobileClose = document.getElementById('mega-mobile-close');

    let activeIndex = null;
    let hideTimeout = null;

    function showDropdown(index) {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
      activeIndex = index;
      const panel = panels[index];
      if (!panel || !bg || !wrapper) return;

      // Hide all panels first so they don't stack
      panels.forEach((p) => {
        p.classList.add('opacity-0', 'pointer-events-none');
        p.classList.remove('opacity-100');
      });
      // Show only the active panel
      panel.classList.remove('opacity-0', 'pointer-events-none');
      panel.classList.add('opacity-100');
      const rect = panel.getBoundingClientRect();
      const navRect = wrapper.getBoundingClientRect();

      // Position and size the background
      bg.style.width = rect.width + 'px';
      bg.style.height = rect.height + 'px';
      bg.style.minHeight = '0';
      bg.style.opacity = '1';
      bg.style.transform = 'translateX(' + rect.left + 'px)';

      // Update aria
      triggers.forEach((t, i) => {
        t.setAttribute('aria-expanded', String(i === index));
      });
    }

    function hideDropdown() {
      hideTimeout = setTimeout(() => {
        activeIndex = null;
        if (bg) {
          bg.style.opacity = '0';
          bg.style.height = '0';
          bg.style.minHeight = '0';
        }
        panels.forEach((p) => {
          p.classList.add('opacity-0', 'pointer-events-none');
          p.classList.remove('opacity-100');
        });
        triggers.forEach((t) => t.setAttribute('aria-expanded', 'false'));
      }, 100);
    }

    triggers.forEach((btn, idx) => {
      btn.addEventListener('mouseenter', () => showDropdown(idx));
      btn.addEventListener('focus', () => showDropdown(idx));
      btn.addEventListener('mouseleave', hideDropdown);
      btn.addEventListener('blur', () => {
        // Delay to allow focus to move to dropdown links
        setTimeout(hideDropdown, 150);
      });
    });

    wrapper?.addEventListener('mouseenter', () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
    });
    wrapper?.addEventListener('mouseleave', hideDropdown);
    wrapper?.addEventListener('focusout', () => setTimeout(hideDropdown, 150));

    // Mobile
    mobileToggle?.addEventListener('click', () => {
      mobileMenu?.classList.remove('hidden');
      mobileMenu?.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    });
    mobileClose?.addEventListener('click', () => {
      mobileMenu?.classList.add('hidden');
      mobileMenu?.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    });
    mobileMenu?.querySelectorAll('a').forEach((a) => {
      a.addEventListener('click', () => {
        mobileMenu?.classList.add('hidden');
        document.body.style.overflow = '';
      });
    });
  })();
</script>

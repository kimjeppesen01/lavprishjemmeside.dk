---
/**
 * Scroll-pinned horizontal product carousel with scroll-driven scale.
 * Section stays fixed while the carousel scales from 0.5â†’1 and slides move horizontally on vertical scroll.
 * Uses GSAP ScrollTrigger. Requires client:load for GSAP.
 *
 * Props:
 *   slides: array of { img, alt?, caption? }
 *   heading?: sr-only or visible heading
 */
interface Props {
  slides: Array<{
    img: string;
    alt?: string;
    caption?: string;
  }>;
  heading?: string;
}

const { slides = [], heading = 'Udvalgte produkter' } = Astro.props;

const defaultSlides = slides.length > 0 ? slides : [
  { img: 'https://images.unsplash.com/photo-1583394838336-acd977736f90?w=800', alt: 'Produkt 1' },
  { img: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=800', alt: 'Produkt 2' },
  { img: 'https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?w=800', alt: 'Produkt 3' },
  { img: 'https://images.unsplash.com/photo-1556742044-3c52e6e84cbd?w=800', alt: 'Produkt 4' },
  { img: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800', alt: 'Produkt 5' },
];
---

<section
  id="product-carousel"
  aria-labelledby="product-carousel-heading"
  class="relative w-full h-[500px] md:h-[600px] my-16 overflow-hidden"
>
  <h2 id="product-carousel-heading" class="sr-only">{heading}</h2>

  <div id="product-carousel-scale-wrapper" class="h-full origin-center">
    <div class="overflow-hidden h-full">
      <ul id="product-carousel-wrapper" class="flex h-full gap-8 md:gap-12 pl-4 md:pl-8">
        {defaultSlides.map((slide) => (
          <li class="flex-none w-[52vw] md:w-[38vw] h-full shrink-0">
            <figure class="w-full h-full overflow-hidden rounded-[var(--radius-card)] shadow-[var(--shadow-card)]">
              <img
                src={slide.img}
                alt={slide.alt ?? slide.caption ?? 'Produkt'}
                class="w-full h-full object-cover"
                loading="lazy"
                decoding="async"
              />
              {slide.caption && (
                <figcaption class="sr-only">{slide.caption}</figcaption>
              )}
            </figure>
          </li>
        ))}
      </ul>
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initProductCarousel() {
    const section = document.getElementById('product-carousel');
    const scaleWrapper = document.getElementById('product-carousel-scale-wrapper');
    const list = document.getElementById('product-carousel-wrapper');
    if (!section || !scaleWrapper || !list) return;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      scaleWrapper.style.transform = 'scale(1)';
      return;
    }

    const slides = Array.from(list.children);
    if (slides.length === 0) return;

    const totalWidth = list.scrollWidth - window.innerWidth;
    const scrollDistance = totalWidth > 0 ? totalWidth : window.innerHeight;

    gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: () => `+=${scrollDistance}`,
        scrub: true,
        pin: true,
        anticipatePin: 1,
        invalidateOnRefresh: true,
      },
    })
      .fromTo(scaleWrapper, { scale: 0.5 }, { scale: 1 }, 0)
      .to(list, { x: -Math.max(0, totalWidth), ease: 'none' }, 0);
  }

  if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initProductCarousel);
    } else {
      initProductCarousel();
    }
  }
</script>

---
import { buildSrcset } from '../utils/image';

interface Props {
  images: Array<{ url: string; alt: string; caption?: string }>;
  columns?: 2 | 3 | 4;
  lightbox?: boolean;
  instanceId?: string | number;
}

const { images = [], columns = 3, lightbox = true, instanceId = 'default' } = Astro.props;

const colClass =
  columns === 2
    ? 'md:grid-cols-2'
    : columns === 4
      ? 'md:grid-cols-2 lg:grid-cols-4'
      : 'md:grid-cols-2 lg:grid-cols-3';

const galleryId = 'gallery-' + Math.random().toString(36).slice(2);
---

<section
  class="py-[var(--section-padding-y)] px-[var(--container-padding-x)]"
  aria-label="Billedgalleri"
>
  <div class="mx-auto max-w-[var(--container-max-width)]">
    <div class={`grid grid-cols-1 gap-4 ${colClass}`}>
      {images.map((img, i) => (
        <figure class="group">
          {lightbox ? (
            <button
              type="button"
              class="block w-full overflow-hidden rounded-[var(--radius-lg)] text-left"
              data-lightbox={galleryId}
              data-src={img.url}
              data-alt={img.alt}
              data-index={i}
              aria-label={`Åbn billede ${i + 1}: ${img.alt}`}
            >
              <img
                src={img.url}
                srcset={buildSrcset(img.url, [320, 480, 640])}
                sizes={columns === 2 ? '(max-width: 768px) 100vw, 50vw' : columns === 4 ? '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 25vw' : '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw'}
                alt={img.alt}
                class="h-48 w-full object-cover transition-transform group-hover:scale-105"
                loading="lazy"
              />
            </button>
          ) : (
            <img
              src={img.url}
              srcset={buildSrcset(img.url, [320, 480, 640])}
              sizes={columns === 2 ? '(max-width: 768px) 100vw, 50vw' : columns === 4 ? '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 25vw' : '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw'}
              alt={img.alt}
              class="h-48 w-full rounded-[var(--radius-lg)] object-cover"
              loading="lazy"
            />
          )}
          {img.caption && (
            <figcaption
              class="mt-2 text-[var(--font-size-base)] text-[var(--color-text-secondary)]"
              style="font-family: var(--font-body)"
            >
              {img.caption}
            </figcaption>
          )}
        </figure>
      ))}
    </div>
  </div>
  {lightbox && (
    <dialog
      id={`${galleryId}-dialog`}
      class="fixed inset-0 z-50 m-0 flex max-h-full max-w-full items-center justify-center border-0 bg-transparent p-4 backdrop:bg-[var(--color-neutral-900)]/90 [&::backdrop]:backdrop-blur-sm"
      aria-label="Billede i fuld størrelse"
    >
      <button
        type="button"
        class="absolute right-4 top-4 flex h-10 w-10 items-center justify-center rounded-[var(--radius-full)] bg-[var(--color-bg-page)] text-[var(--color-text-primary)] transition-colors hover:bg-[var(--color-neutral-100)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
        aria-label="Luk"
        data-lightbox-close
      >
        ✕
      </button>
      <img
        src=""
        alt=""
        class="max-h-[90vh] max-w-full rounded-[var(--radius-lg)] object-contain shadow-[var(--shadow-lg)]"
        data-lightbox-img
      />
    </dialog>
  )}
</section>

{lightbox && (
  <script is:inline>
    (function(){
      if (window.__galleryLightboxInit) return;
      window.__galleryLightboxInit = true;
      document.addEventListener('click', function(e) {
      var trigger = (e.target && 'closest' in e.target) ? e.target.closest('[data-lightbox]') : null;
        if (trigger) {
          e.preventDefault();
          var id = trigger.getAttribute('data-lightbox');
          var dialogEl = id ? document.getElementById(id + '-dialog') : null;
          var imgEl = dialogEl && dialogEl.querySelector('[data-lightbox-img]');
          if (dialogEl && imgEl && typeof dialogEl.showModal === 'function') {
            imgEl.src = trigger.getAttribute('data-src') || trigger.getAttribute('href') || '';
            imgEl.alt = trigger.getAttribute('data-alt') || (trigger.querySelector('img') && trigger.querySelector('img').getAttribute('alt')) || '';
            dialogEl.showModal();
          }
        }
      var closeBtn = (e.target && 'closest' in e.target) ? e.target.closest('[data-lightbox-close]') : null;
        if (closeBtn) {
          var d = closeBtn.closest('dialog');
          if (d && typeof d.close === 'function') d.close();
        }
        if (e.target && e.target.tagName === 'DIALOG' && e.target.open) {
          e.target.close();
        }
      });
    })();
  </script>
)}

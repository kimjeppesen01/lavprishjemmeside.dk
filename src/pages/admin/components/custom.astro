---
import AdminLayout from '../../../layouts/AdminLayout.astro';
const apiUrl = import.meta.env.PUBLIC_API_URL || 'https://api.lavprishjemmeside.dk';
---

<AdminLayout title="Egne komponenter">
  <div class="max-w-7xl mx-auto">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Egne komponenter</h1>
      <p class="text-gray-600 mt-2">Komponenter tilføjes her via Claude Code eller sync. De overskrives ikke af CMS-opdateringer.</p>
    </div>

    <div id="loading" class="text-center py-12 text-gray-500">Henter komponenter...</div>

    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-red-700 mb-2" id="error-text"></p>
      <button type="button" onclick="window.location.reload()" class="text-red-600 underline text-sm">Prøv igen</button>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-16 px-4 bg-gray-50 rounded-xl border border-gray-200">
      <p class="text-gray-600 text-lg mb-2">Ingen egne komponenter endnu.</p>
      <p class="text-gray-500 text-sm">Komponenter tilføjes her via Claude Code eller sync.</p>
    </div>

    <!-- List of custom components -->
    <div id="content" class="hidden">
      <div id="components-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      </div>
    </div>
  </div>

  <script define:vars={{ apiUrl }}>
  (function() {
    const API = apiUrl;
    const token = localStorage.getItem('admin_token');

    if (!token) {
      window.location.href = '/admin/';
      return;
    }

    async function loadComponents() {
      try {
        const res = await fetch(API + '/components?source=custom', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          if (res.status === 401) {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin/';
            return;
          }
          throw new Error('Fejl ved indlæsning af komponenter');
        }

        const components = await res.json();
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const emptyState = document.getElementById('empty-state');
        const content = document.getElementById('content');
        const grid = document.getElementById('components-grid');

        loading.classList.add('hidden');

        if (components.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        content.classList.remove('hidden');
        grid.innerHTML = '';

        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
        function escapeAttr(text) {
          if (!text) return '';
          return String(text).replace(/["']/g, '');
        }

        components.forEach(function(comp) {
          const slugEnc = encodeURIComponent(comp.slug);
          const propsCount = comp.default_props ? Object.keys(typeof comp.default_props === 'string' ? JSON.parse(comp.default_props) : comp.default_props).length : 0;
          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow';
          card.innerHTML =
            '<div class="mb-4">' +
              '<h3 class="text-lg font-semibold text-gray-900 mb-1">' + escapeHtml(comp.name) + '</h3>' +
              '<p class="text-sm text-gray-500">' + escapeHtml(comp.slug) + '</p>' +
            '</div>' +
            '<div class="mb-4 flex flex-wrap gap-2">' +
              '<span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Egne</span>' +
              '<span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">' + propsCount + ' egenskaber</span>' +
            '</div>' +
            '<p class="text-sm text-gray-600 mb-4 line-clamp-2">' + escapeHtml(comp.description || '(Ingen beskrivelse)') + '</p>' +
            '<a href="/admin/components/preview/' + slugEnc + '/" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium px-4 py-2 rounded transition-colors text-sm">Forhåndsvis</a>';
          grid.appendChild(card);
        });
      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-text').textContent = 'Fejl: ' + err.message;
        document.getElementById('error').classList.remove('hidden');
      }
    }

    loadComponents();
  })();
  </script>
</AdminLayout>

---
import AdminLayout from '../../layouts/AdminLayout.astro';
const apiUrl = import.meta.env.PUBLIC_API_URL || 'https://api.lavprishjemmeside.dk';
---

<AdminLayout title="Temaer">
  <div class="max-w-6xl mx-auto">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Temaer</h1>
      <p class="text-gray-600 mt-2">Vælg UX/design-type uafhængigt af farver og typografi.</p>
    </div>

    <div id="loading" class="text-center py-12 text-gray-500">Henter temaindstillinger...</div>

    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-red-700 mb-2" id="error-text"></p>
      <button onclick="window.location.reload()" class="text-red-600 underline text-sm">Prøv igen</button>
    </div>
    <div id="warning" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
      <p class="text-amber-800 text-sm" id="warning-text"></p>
    </div>

    <div id="content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Design-type</h2>
        <p class="text-sm text-gray-600 mb-6">Dette ændrer komponentstruktur, layout-rytme og animationer. Styling (farver, fonts) styres fortsat under “Design & styling”.</p>

        <div id="theme-cards" class="grid gap-4 md:grid-cols-3"></div>

        <div class="mt-8">
          <label class="block text-sm font-medium text-gray-700 mb-2">Bevægelsesprofil</label>
          <select id="motion_profile" class="w-full max-w-xs border border-gray-300 rounded px-3 py-2">
            <option value="standard">Standard</option>
            <option value="reduced">Reduceret</option>
            <option value="expressive">Expressive</option>
          </select>
        </div>

        <div class="mt-8 flex gap-3">
          <button id="save-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Gem tema</button>
          <button id="publish-btn" class="px-5 py-2.5 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium">Publicer til live</button>
        </div>
      </section>

      <aside class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-3">Aktiv konfiguration</h3>
        <p class="text-sm text-gray-600">Tema: <span id="active-theme-label" class="font-medium text-gray-900">-</span></p>
        <p class="text-sm text-gray-600 mt-1">Motion: <span id="active-motion-label" class="font-medium text-gray-900">-</span></p>
        <div id="success" class="hidden mt-4 text-sm text-green-700 bg-green-50 border border-green-200 rounded p-3">Gemte temaindstillinger.</div>
      </aside>
    </div>
  </div>

  <script define:vars={{ apiUrl }}>
    (function() {
      const API = apiUrl;
      const token = localStorage.getItem('admin_token');
      if (!token) {
        window.location.href = '/admin/';
        return;
      }

      const THEMES = [
        { key: 'simple', label: 'Simple', description: 'Nuværende professionelle layout.' },
        { key: 'modern', label: 'Modern', description: 'Markant moderne UX med ny rytme og motion.' },
        { key: 'kreativ', label: 'Kreativ', description: 'Kreativ variant (næste fase).' },
      ];

      let current = { active_theme_key: 'simple', motion_profile: 'standard' };
      let legacyThemeApi = false;

      function setError(msg) {
        const error = document.getElementById('error');
        const errorText = document.getElementById('error-text');
        if (errorText) errorText.textContent = msg;
        if (error) error.classList.remove('hidden');
      }

      function setWarning(msg) {
        const warning = document.getElementById('warning');
        const warningText = document.getElementById('warning-text');
        if (warningText) warningText.textContent = msg;
        if (warning) warning.classList.remove('hidden');
      }

      function renderCards() {
        const holder = document.getElementById('theme-cards');
        if (!holder) return;
        holder.innerHTML = THEMES.map((t) => `
          <button type="button" data-theme-key="${t.key}" class="theme-card text-left border rounded-lg p-4 transition ${current.active_theme_key === t.key ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}">
            <div class="font-semibold text-gray-900">${t.label}</div>
            <p class="text-sm text-gray-600 mt-1">${t.description}</p>
          </button>
        `).join('');
        holder.querySelectorAll('[data-theme-key]').forEach((el) => {
          el.addEventListener('click', () => {
            current.active_theme_key = el.getAttribute('data-theme-key');
            renderCards();
            renderActive();
          });
        });
      }

      function renderActive() {
        const theme = THEMES.find((t) => t.key === current.active_theme_key);
        const t = document.getElementById('active-theme-label');
        const m = document.getElementById('active-motion-label');
        if (t) t.textContent = theme ? theme.label : current.active_theme_key;
        if (m) m.textContent = current.motion_profile;
      }

      async function loadThemeSettings() {
        try {
          const endpoint = API + '/theme-settings';
          const res = await fetch(endpoint, {
            headers: { Authorization: 'Bearer ' + token }
          });
          if (res.status === 404) {
            legacyThemeApi = true;
            await loadLegacyThemeSettings();
            return;
          }
          if (!res.ok) {
            let detail = '';
            try {
              const body = await res.json();
              detail = body && body.error ? ` (${body.error})` : '';
            } catch (_) {}
            throw new Error(`Kunne ikke hente temaindstillinger [${res.status}] ${endpoint}${detail}`);
          }
          const data = await res.json();
          current = {
            active_theme_key: data.active_theme_key || 'simple',
            motion_profile: data.motion_profile || 'standard',
          };
          const motion = document.getElementById('motion_profile');
          if (motion) motion.value = current.motion_profile;
          renderCards();
          renderActive();
          document.getElementById('loading')?.classList.add('hidden');
          document.getElementById('content')?.classList.remove('hidden');
        } catch (err) {
          // Failsafe: still allow UI interaction with defaults.
          current = { active_theme_key: 'simple', motion_profile: 'standard' };
          const motion = document.getElementById('motion_profile');
          if (motion) motion.value = current.motion_profile;
          renderCards();
          renderActive();
          document.getElementById('loading')?.classList.add('hidden');
          document.getElementById('content')?.classList.remove('hidden');
          setWarning((err && err.message) ? err.message + '. Viser standardværdier.' : 'Kunne ikke hente temaindstillinger. Viser standardværdier.');
        }
      }

      function inferThemeFromPreset(preset) {
        const name = String((preset && preset.name) || '').toLowerCase();
        const label = String((preset && preset.label_da) || '').toLowerCase();
        if (name.includes('modern') || name.includes('minimal') || label.includes('modern') || label.includes('minimal')) return 'modern';
        if (name.includes('kreativ') || name.includes('creative') || label.includes('kreativ') || label.includes('creative')) return 'kreativ';
        return 'simple';
      }

      async function loadLegacyThemeSettings() {
        const settingsRes = await fetch(API + '/design-settings', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!settingsRes.ok) throw new Error(`Legacy load failed [${settingsRes.status}] ${API + '/design-settings'}`);
        const settings = await settingsRes.json();

        let inferred = 'simple';
        if (settings && settings.theme_mode === 'modern') {
          inferred = 'modern';
        } else {
          try {
            const presetsRes = await fetch(API + '/theme-presets/', {
              headers: { Authorization: 'Bearer ' + token }
            });
            if (presetsRes.ok) {
              const presets = await presetsRes.json();
              const active = Array.isArray(presets) ? presets.find((p) => Number(p.id) === Number(settings.active_preset_id)) : null;
              if (active) inferred = inferThemeFromPreset(active);
            }
          } catch (_) {}
        }

        current = { active_theme_key: inferred, motion_profile: 'standard' };
        const motion = document.getElementById('motion_profile');
        if (motion) motion.value = 'standard';
        renderCards();
        renderActive();
        document.getElementById('loading')?.classList.add('hidden');
        document.getElementById('content')?.classList.remove('hidden');
        setWarning('Kører i legacy theme mode (theme-settings endpoint mangler).');
      }

      document.getElementById('save-btn')?.addEventListener('click', async () => {
        const motion = document.getElementById('motion_profile');
        if (motion) current.motion_profile = motion.value;
        try {
          if (legacyThemeApi) {
            await saveLegacyThemeSettings();
            return;
          }
          const endpoint = API + '/theme-settings/update';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(current)
          });
          if (!res.ok) {
            let detail = '';
            try {
              const body = await res.json();
              detail = body && body.error ? ` (${body.error})` : '';
            } catch (_) {}
            throw new Error(`Kunne ikke gemme tema [${res.status}] ${endpoint}${detail}`);
          }
          const data = await res.json();
          current.active_theme_key = data.active_theme_key || current.active_theme_key;
          current.motion_profile = data.motion_profile || current.motion_profile;
          renderCards();
          renderActive();
          const success = document.getElementById('success');
          if (success) {
            success.classList.remove('hidden');
            setTimeout(() => success.classList.add('hidden'), 3000);
          }
        } catch (err) {
          setError(err.message || 'Gemning fejlede');
        }
      });

      async function saveLegacyThemeSettings() {
        const presetsRes = await fetch(API + '/theme-presets/', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!presetsRes.ok) throw new Error(`Legacy save failed [${presetsRes.status}] ${API + '/theme-presets/'}`);
        const presets = await presetsRes.json();
        const target = (Array.isArray(presets) ? presets : []).find((p) => inferThemeFromPreset(p) === current.active_theme_key);

        if (target) {
          const applyRes = await fetch(API + '/design-settings/apply-preset', {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ preset_id: target.id })
          });
          if (!applyRes.ok) {
            let detail = '';
            try {
              const body = await applyRes.json();
              detail = body && body.error ? ` (${body.error})` : '';
            } catch (_) {}
            throw new Error(`Kunne ikke gemme tema [${applyRes.status}] ${API + '/design-settings/apply-preset'}${detail}`);
          }
        } else if (current.active_theme_key !== 'kreativ') {
          // Last fallback for very old installs with theme_mode column.
          const updateRes = await fetch(API + '/design-settings/update', {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ theme_mode: current.active_theme_key === 'modern' ? 'modern' : 'simple' })
          });
          if (!updateRes.ok) {
            throw new Error(`Kunne ikke gemme tema [${updateRes.status}] ${API + '/design-settings/update'}`);
          }
        } else {
          throw new Error('Kunne ikke gemme Kreativ i legacy mode: preset mangler.');
        }

        renderCards();
        renderActive();
        const success = document.getElementById('success');
        if (success) {
          success.classList.remove('hidden');
          setTimeout(() => success.classList.add('hidden'), 3000);
        }
      }

      document.getElementById('publish-btn')?.addEventListener('click', async () => {
        try {
          const res = await fetch(API + '/publish', {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token }
          });
          if (!res.ok) throw new Error('Publicering fejlede');
          const success = document.getElementById('success');
          if (success) {
            success.textContent = 'Tema publiceret. Vent ca. 90 sekunder.';
            success.classList.remove('hidden');
            setTimeout(() => {
              success.classList.add('hidden');
              success.textContent = 'Gemte temaindstillinger.';
            }, 4000);
          }
        } catch (err) {
          setError(err.message || 'Publicering fejlede');
        }
      });

      loadThemeSettings();
    })();
  </script>
</AdminLayout>
